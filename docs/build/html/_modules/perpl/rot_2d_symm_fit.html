<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>perpl.rot_2d_symm_fit &#8212; PERPL  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for perpl.rot_2d_symm_fit</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Wed Oct 2 14:50:19 2019</span>

<span class="sd">Functions for creating models with rotational symmetry and fitting.</span>

<span class="sd">Alistair Curd</span>
<span class="sd">University of Leeds</span>
<span class="sd">2 October 2019</span>

<span class="sd">Software Engineering practices applied</span>

<span class="sd">Joanna Leng (an EPSRC funded Research Software Engineering Fellow (EP/R025819/1)</span>
<span class="sd">University of Leeds</span>
<span class="sd">October 2019</span>

<span class="sd">---</span>
<span class="sd">Copyright 2019 Peckham Lab</span>

<span class="sd">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use</span>
<span class="sd">this file except in compliance with the License. You may obtain a copy of the</span>
<span class="sd">License at</span>
<span class="sd">http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">Unless required by applicable law or agreed to in writing, software distributed</span>
<span class="sd">under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="sd">CONDITIONS OF ANY KIND, either express or implied. See the License for the</span>
<span class="sd">specific language governing permissions and limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">timeit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tkinter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tkinter.filedialog</span><span class="w"> </span><span class="kn">import</span> <span class="n">askopenfilename</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">plotting</span><span class="p">,</span> <span class="n">reports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.modelling.background_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">zero_to_constant_gradient</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">perpl.modelling.modelling_general</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.modelling.modelling_general</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelWithFitSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.modelling.modelling_general</span><span class="w"> </span><span class="kn">import</span> <span class="n">stdev_of_model</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">perpl.statistics.modelstats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.relative_positions</span><span class="w"> </span><span class="kn">import</span> <span class="n">getdistances</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>


<div class="viewcode-block" id="Number">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.Number">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Number</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class object providing only a number, to be passed to rotational</span>
<span class="sd">    symmetry models to provide the order of symmetry, without being fitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">number</span></div>



<div class="viewcode-block" id="get_inputs">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.get_inputs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_inputs</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a file browser to reads the filename and then reads the other</span>
<span class="sd">       inputs as text from the command line. Puts inputs into the doctionary.</span>
<span class="sd">       These are:</span>
<span class="sd">           in_file_and_path (string): The input filename and path.</span>
<span class="sd">           filterdist (int): The distance within which relative positions were calculated.</span>
<span class="sd">           verbose (Boolean): If True prints outputs to screen as program executes.</span>
<span class="sd">    Args:</span>
<span class="sd">        info (dict): A python dictionary containing a collection of useful parameters</span>
<span class="sd">            such as the filenames and paths.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#root = Tk()</span>
    <span class="n">Tk</span><span class="p">()</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Please select input file containing relative positions to assess &#39;</span>
          <span class="s1">&#39;for rotational symmetry (.csv or .txt with comma delimiters).&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The file should contain an array with one relative position &#39;</span>
          <span class="s1">&#39;vector per row. &#39;</span>
          <span class="s1">&#39;The first two columns of the array (e.g. X-separation, Y-separation) &#39;</span>
          <span class="s1">&#39;will be used for the investigation.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">infile</span> <span class="o">=</span> <span class="n">askopenfilename</span><span class="p">()</span>
    <span class="c1">#root.destroy()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file you selected is: &quot;</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;in_file_and_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">infile</span>



    <span class="c1"># Set longest distance used between localisations when producing</span>
    <span class="c1"># distance histograms and fitting.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fitlength</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;What is the maximum distance between &#39;</span>
                              <span class="s1">&#39;localisations that you would like to use in the &#39;</span>
                              <span class="s1">&#39;analysis (nm)? &#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This must be an integer.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;The filter distance must be an integer.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filter_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitlength</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you want updates printed to the screen as the analysis &#39;</span>
          <span class="s1">&#39;progresses?&#39;</span><span class="p">)</span>


    <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;yes/no </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">):</span>
        <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">silent</span></div>



<div class="viewcode-block" id="rot_sym_only">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rot_sym_only">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rot_sym_only</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                 <span class="n">diameter</span><span class="p">,</span>
                 <span class="n">broadening</span><span class="p">,</span>
                 <span class="n">amplitude</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Broadening is modelled assuming Gaussian imprecision on</span>
<span class="sd">    the positions of the vertices.</span>

<span class="sd">    Calls sym_order.number from outside, so that the degree of symmetry os</span>
<span class="sd">    not fitted when this function is passed to scipy.optimize.curve_fit.</span>

<span class="sd">    Args:</span>
<span class="sd">        separation_values (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        diameter (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        broadening (float):</span>
<span class="sd">            Broadening of the peaks located at distances between the vertices.</span>
<span class="sd">        amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of one inter-vertex distance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model at the</span>
<span class="sd">            separation_values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">generate_polygon_points</span><span class="p">(</span><span class="n">sym_order</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                              <span class="n">diameter</span><span class="p">)</span>
    <span class="n">filter_distance</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">diameter</span>
    <span class="c1"># getdistances includes removel of duplicates 27/11/2019</span>
    <span class="n">relative_positions</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">filter_distance</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xy_separations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                             <span class="o">+</span> <span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Initialise array for set of density values.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">separation_values</span> <span class="o">*</span> <span class="mf">0.</span>

    <span class="c1"># Add 2D pair correlations at the distances between vertices.</span>
    <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="n">xy_separations</span><span class="p">:</span>
        <span class="n">rpd</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpd</span>
               <span class="o">+</span> <span class="p">(</span><span class="n">amplitude</span> <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                             <span class="n">distance</span><span class="p">,</span>
                                                             <span class="n">broadening</span><span class="p">)</span>
                  <span class="p">)</span>
               <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="rot_sym_with_replocs_and_substructure_isotropic_bg">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rot_sym_with_replocs_and_substructure_isotropic_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rot_sym_with_replocs_and_substructure_isotropic_bg</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">dia</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
        <span class="n">bggrad</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>
<span class="sd">    Args:</span>
<span class="sd">        r:      Distances at which density values of the model</span>
<span class="sd">                    will be obtained.</span>
<span class="sd">        dia:    Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertssd: Broadening of the peaks located at</span>
<span class="sd">                    distances between the vertices.</span>
<span class="sd">        vertsamp:  Amplitude of the contribution of one inter-vertex distance.</span>
<span class="sd">        replocssd: Spread representing localisation precision for repeated</span>
<span class="sd">                    localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp: Amplitude of the contribution of repeated localisations</span>
<span class="sd">                        of the same fluorescent molecule.</span>
<span class="sd">        substructsd: Spread of a contribution resulting from unresolvable</span>
<span class="sd">                        substructure, or mislocalisations resulting from</span>
<span class="sd">                        a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructamp: Amplitude of the contribution of unresolvable</span>
<span class="sd">                        substructure, or mislocalisations resulting from</span>
<span class="sd">                        a combination of simultaneous nearby emitters.</span>
<span class="sd">        bggrad: Gradient of an isotropic (linearly increasing) background term.</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd:    The relative position density given by the model</span>
<span class="sd">                    at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get RPD arising from rotationally symmetric structure with broadening</span>
    <span class="c1"># only from imprecision on single vertex points.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_only</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dia</span><span class="p">,</span> <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">)</span>

    <span class="c1"># Add 2D isotropic background</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">bggrad</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">background</span>
    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">replocsamp</span> <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span><span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">substructamp</span> <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="rot_sym_replocs_substructure_isotropic_bg_with_onset">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rot_sym_replocs_substructure_isotropic_bg_with_onset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rot_sym_replocs_substructure_isotropic_bg_with_onset</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">dia</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
        <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>

<span class="sd">    In this model, we take account of the fact that rotationally</span>
<span class="sd">    symmetric structures may be unlikely to be found within one another:</span>
<span class="sd">    we allow the isotropic (linearly increasing) background term to</span>
<span class="sd">    remain zero until an onset distance (bgonset) is reached.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        dia (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertsd (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">            distances between the vertices.</span>
<span class="sd">        vertsamp (float):</span>
<span class="sd">            Amplitude of the contribution of one inter-vertex distance.</span>
<span class="sd">        replocssd (float):</span>
<span class="sd">            Spread representing localisation precision for repeated</span>
<span class="sd">            localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">            of the same fluorescent molecule.</span>
<span class="sd">        substructsd (float):</span>
<span class="sd">            Spread of a contribution resulting from unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructamp (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        bggrad (float):</span>
<span class="sd">            Gradient of an isotropic (linearly increasing) background term.</span>
<span class="sd">        bgonset (float):</span>
<span class="sd">            Onset distance for linearly increasing background term,</span>
<span class="sd">            since rotationally symmetric structures may exclude</span>
<span class="sd">            one another.</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model</span>
<span class="sd">            at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># GETDISTANCES IS CALLED BY relative_positions.py.</span>
    <span class="c1"># There is an option to set verbose=True if output to screen if desired.</span>

    <span class="c1"># Get RPD arising from rotationally symmetric structure with broadening</span>
    <span class="c1"># only from imprecision on single vertex points.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_only</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dia</span><span class="p">,</span> <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">)</span>

    <span class="c1"># Isotropic 2D background after an onset distance.</span>
    <span class="c1"># Background is zero before the onset distance.</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">bggrad</span> <span class="o">-</span> <span class="n">bggrad</span> <span class="o">*</span> <span class="n">bgonset</span>
    <span class="n">background</span><span class="p">[</span><span class="n">background</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">background</span>

    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">replocsamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset_vectorargs">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset_vectorargs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset_vectorargs</span><span class="p">(</span>
        <span class="n">input_vector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to calculate the values given by</span>
<span class="sd">    rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset, but using a</span>
<span class="sd">    vector input for the parameters, so that the numdifftools package can be</span>
<span class="sd">    used to calculate partial derivatives for correct error propagation in the</span>
<span class="sd">    model.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_vector (list or numpy array):</span>
<span class="sd">            A concatenation of:</span>
<span class="sd">                1. A distance at which density values of the model will be</span>
<span class="sd">                obtained (numpy array)</span>

<span class="sd">                2. The parameters used by</span>
<span class="sd">                rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset.</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model at the input</span>
<span class="sd">            distances (called separation_values_1d).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">separation_values_1d</span><span class="p">,</span>
     <span class="n">dia</span><span class="p">,</span>
     <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>
     <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
     <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
     <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_vector</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_replocs_substructure_isotropic_bg_with_onset</span><span class="p">(</span>
        <span class="n">separation_values_1d</span><span class="p">,</span>
        <span class="n">dia</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
        <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="rot_sym_with_replocs_and_substructure_isotropic_bg_with_smooth_onset">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rot_sym_with_replocs_and_substructure_isotropic_bg_with_smooth_onset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rot_sym_with_replocs_and_substructure_isotropic_bg_with_smooth_onset</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">dia</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
        <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span><span class="p">,</span> <span class="n">bgvariation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>

<span class="sd">    In this model, we take account of the fact that rotationally</span>
<span class="sd">    symmetric structures may be unlikely to be found within one another,</span>
<span class="sd">    with a differentiable background term varying from</span>
<span class="sd">    zero_to_constant_gradient.</span>

<span class="sd">    Args:</span>
<span class="sd">        r (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        dia (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertsd (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">                    distances between the vertices.</span>
<span class="sd">        vertsamp (float):</span>
<span class="sd">            Amplitude of the contribution of one inter-vertex distance.</span>
<span class="sd">        replocssd (float):</span>
<span class="sd">            Spread representing localisation precision for repeated</span>
<span class="sd">                    localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">                        of the same fluorescent molecule.</span>
<span class="sd">        substructsd (float):</span>
<span class="sd">            Spread of a contribution resulting from unresolvable</span>
<span class="sd">                        substructure, or mislocalisations resulting from</span>
<span class="sd">                        a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructamp (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">                        substructure, or mislocalisations resulting from</span>
<span class="sd">                        a combination of simultaneous nearby emitters.</span>
<span class="sd">        bggrad (float):</span>
<span class="sd">            The gradient of the background term  at large separation_values.</span>
<span class="sd">        bgonset (float):</span>
<span class="sd">            A characteristic value of the background term, between tending to</span>
<span class="sd">            zero and tending a constant gradient.</span>
<span class="sd">        bgvariation:</span>
<span class="sd">            Determines the amount of variation on the background term</span>
<span class="sd">            in the intermediate range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model</span>
<span class="sd">                    at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># GETDISTANCES IS CALLED BY relative_positions.py.</span>
    <span class="c1"># There is an option to set verbose=True if output to screen if desired.</span>

    <span class="c1"># Get RPD arising from rotationally symmetric structure with broadening</span>
    <span class="c1"># only from imprecision on single vertex points.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_only</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span> <span class="n">dia</span><span class="p">,</span> <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">)</span>

    <span class="c1"># Add 2D isotropic background with onset distance.</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">zero_to_constant_gradient</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                           <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span><span class="p">,</span> <span class="n">bgvariation</span><span class="p">)</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">background</span>
    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">replocsamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span><span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span><span class="p">)</span>
                 <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="test_plot_withvectorinput">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.test_plot_withvectorinput">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_plot_withvectorinput</span><span class="p">(</span><span class="n">relpos</span><span class="p">,</span>
                              <span class="n">model_with_info</span><span class="p">,</span>
                              <span class="n">fitlength</span><span class="o">=</span><span class="mf">200.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Testing vector-input version of parametric model function.&quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">xy_histogram</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">make_xy_histogram_nm</span><span class="p">(</span><span class="n">relpos</span><span class="p">,</span> <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">,</span>
                                               <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sym_order</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
     <span class="n">params_covar</span><span class="p">,</span>
     <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span><span class="n">xy_histogram</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
                                                        <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">)</span>

    <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fitlength</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

    <span class="n">vector_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">params_optimised</span><span class="p">)</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset_vectorargs</span><span class="p">(</span><span class="n">vector_input</span><span class="p">)</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">rpd</span><span class="p">)</span></div>



<div class="viewcode-block" id="rotsym_withreplocs_nosubstructure_isotropicbgwithonset">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rotsym_withreplocs_nosubstructure_isotropicbgwithonset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotsym_withreplocs_nosubstructure_isotropicbgwithonset</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">dia</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>

<span class="sd">    In this model, we take account of the fact that rotationally</span>
<span class="sd">    symmetric structures may be unlikely to be found within one another:</span>
<span class="sd">    we allow the isotropic (linearly increasing) background term to</span>
<span class="sd">    remain zero until an onset distance (bgonset) is reached.</span>

<span class="sd">    Args:</span>
<span class="sd">        r:      Distances at which density values of the model</span>
<span class="sd">                    will be obtained.</span>
<span class="sd">        dia:    Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertsd: Broadening of the peaks located at</span>
<span class="sd">                    distances between the vertices.</span>
<span class="sd">        vertsamp:  Amplitude of the contribution of one inter-vertex distance.</span>
<span class="sd">        replocssd: Spread representing localisation precision for repeated</span>
<span class="sd">                    localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp: Amplitude of the contribution of repeated localisations</span>
<span class="sd">                        of the same fluorescent molecule.</span>
<span class="sd">        bggrad: Gradient of an isotropic (linearly increasing) background term.</span>
<span class="sd">        bgonset: Onset distance for linearly increasing background term,</span>
<span class="sd">                    since rotationally symmetric structures may exclude</span>
<span class="sd">                    one another.</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd:    The relative position density given by the model</span>
<span class="sd">                    at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get positions of vertices, their relative positions</span>
    <span class="c1"># and distances between them.</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">generate_polygon_points</span><span class="p">(</span><span class="n">sym_order</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">dia</span><span class="p">)</span>
    <span class="n">relpos</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">filterdist</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dia</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">relpos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">relpos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Select unduplicated distances between the vertices.</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">sym_order</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="c1"># sigma = np.array([sigma0, sigma1, sigma2, sigma3])</span>
    <span class="c1"># Initialise array for set of density values.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="c1"># Add 2D pair correlations at the distances between vertices.</span>
    <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">:</span>
        <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">vertsamp</span> <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">vertssd</span><span class="p">)</span>
    <span class="c1"># Add 2D isotropic background with onset distance.</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">bggrad</span> <span class="o">-</span> <span class="n">bggrad</span> <span class="o">*</span> <span class="n">bgonset</span>
    <span class="n">background</span><span class="p">[</span><span class="n">background</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">background</span>
    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">replocsamp</span> <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="model_replocs_substruct_no_bg">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.model_replocs_substruct_no_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model_replocs_substruct_no_bg</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertices_broadening</span><span class="p">,</span> <span class="n">vertices_amplitude</span><span class="p">,</span>
        <span class="n">rept_locs_broadening</span><span class="p">,</span> <span class="n">rept_locs_amplitude</span><span class="p">,</span>
        <span class="n">substructure_broadening</span><span class="p">,</span> <span class="n">substructure_amplitude</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>

<span class="sd">    No background is included, so that error propagation can be calculated on</span>
<span class="sd">    the portion of the rpd before the hard onset distance of the background.</span>

<span class="sd">    Args:</span>
<span class="sd">        separation_values (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        diameter (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertices_broadening (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">            distances between the vertices.</span>
<span class="sd">        vertices_amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of one inter-vertex distance.</span>
<span class="sd">        rept_locs_broadening (float):</span>
<span class="sd">            Spread representing localisation precision (SD) for repeated</span>
<span class="sd">            localisations of the same fluorescent molecule.</span>
<span class="sd">        rept_locs_amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">            of the same fluorescent molecule.</span>
<span class="sd">        substructure_broadening (float):</span>
<span class="sd">            Spread (SD) of a contribution resulting from unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructure_amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model</span>
<span class="sd">            at the separation_values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get RPD arising from rotationally symmetric structure with broadening</span>
    <span class="c1"># only from imprecision on single vertex points.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_only</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                       <span class="n">diameter</span><span class="p">,</span>
                       <span class="n">vertices_broadening</span><span class="p">,</span>
                       <span class="n">vertices_amplitude</span>
                       <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">rept_locs_amplitude</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">rept_locs_broadening</span><span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructure_amplitude</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructure_broadening</span><span class="p">)</span>
                 <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="model_replocs_substruct_no_bg_vectorargs">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.model_replocs_substruct_no_bg_vectorargs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model_replocs_substruct_no_bg_vectorargs</span><span class="p">(</span><span class="n">input_vector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to calculate the values given by</span>
<span class="sd">    rot_sym_with_replocs_and_substructure_no_bg, but using a</span>
<span class="sd">    vector input for the parameters, so that the numdifftools package can be</span>
<span class="sd">    used to calculate partial derivatives for correct error propagation in the</span>
<span class="sd">    model.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_vector (list or numpy array):</span>
<span class="sd">            A concatenation of:</span>
<span class="sd">                1. Distances at which density values of the model will be</span>
<span class="sd">                obtained (numpy array)</span>

<span class="sd">                2. The parameters used by</span>
<span class="sd">                rot_sym_with_replocs_and_substructure_no_bg.</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model at the input</span>
<span class="sd">            distances (called separation_values).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
     <span class="n">diameter</span><span class="p">,</span>
     <span class="n">vertices_broadening</span><span class="p">,</span> <span class="n">vertices_amplitude</span><span class="p">,</span>
     <span class="n">rept_locs_broadening</span><span class="p">,</span> <span class="n">rept_locs_amplitude</span><span class="p">,</span>
     <span class="n">substructure_broadening</span><span class="p">,</span> <span class="n">substructure_amplitude</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_vector</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">model_replocs_substruct_no_bg</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                        <span class="n">diameter</span><span class="p">,</span>
                                        <span class="n">vertices_broadening</span><span class="p">,</span>
                                        <span class="n">vertices_amplitude</span><span class="p">,</span>
                                        <span class="n">rept_locs_broadening</span><span class="p">,</span>
                                        <span class="n">rept_locs_amplitude</span><span class="p">,</span>
                                        <span class="n">substructure_broadening</span><span class="p">,</span>
                                        <span class="n">substructure_amplitude</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="rot_sym_with_replocs_and_substructure_isotropic_bg_after_onset">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.rot_sym_with_replocs_and_substructure_isotropic_bg_after_onset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rot_sym_with_replocs_and_substructure_isotropic_bg_after_onset</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertices_broadening</span><span class="p">,</span> <span class="n">vertices_amplitude</span><span class="p">,</span>
        <span class="n">rept_locs_broadening</span><span class="p">,</span> <span class="n">rept_locs_amplitude</span><span class="p">,</span>
        <span class="n">substructure_broadening</span><span class="p">,</span> <span class="n">substructure_amplitude</span><span class="p">,</span>
        <span class="n">bg_grad</span><span class="p">,</span> <span class="n">bg_onset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>

<span class="sd">    THIS FUNCTION IS FOR USE AFTER THE ONSET OF A CONSTANT BACKGROUND, AND WILL</span>
<span class="sd">    GIVE NEGATIVE VALUES BEFORE THE BACKGROUND ONSET DISTANCE.</span>

<span class="sd">    A linear (isotropic 2D) background term is used.</span>

<span class="sd">    Args:</span>
<span class="sd">        separation_values (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        diameter (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertices_broadening (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">            distances between the vertices.</span>
<span class="sd">        vertices_amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of one inter-vertex distance.</span>
<span class="sd">        rept_locs_broadening (float):</span>
<span class="sd">            Spread representing localisation precision (SD) for repeated</span>
<span class="sd">            localisations of the same fluorescent molecule.</span>
<span class="sd">        rept_locs_amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">            of the same fluorescent molecule.</span>
<span class="sd">        substructure_broadening (float):</span>
<span class="sd">            Spread (SD) of a contribution resulting from unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructure_amplitude (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        bggrad (float):</span>
<span class="sd">            Gradient of an isotropic (linearly increasing) background term.</span>
<span class="sd">        bgonset (float):</span>
<span class="sd">            Onset distance for linearly increasing background term,</span>
<span class="sd">            since rotationally symmetric structures may exclude</span>
<span class="sd">            one another.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model</span>
<span class="sd">            at the separation_values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get RPD arising from rotationally symmetric structure with broadening</span>
    <span class="c1"># only from imprecision on single vertex points.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_only</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                       <span class="n">diameter</span><span class="p">,</span>
                       <span class="n">vertices_broadening</span><span class="p">,</span>
                       <span class="n">vertices_amplitude</span>
                       <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">rept_locs_amplitude</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">rept_locs_broadening</span><span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructure_amplitude</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructure_broadening</span><span class="p">)</span>
                 <span class="p">)</span>

    <span class="n">background</span> <span class="o">=</span> <span class="n">separation_values</span> <span class="o">*</span> <span class="n">bg_grad</span> <span class="o">-</span> <span class="n">bg_grad</span> <span class="o">*</span> <span class="n">bg_onset</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">background</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="model_linear_bg_after_onset_vectorargs">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.model_linear_bg_after_onset_vectorargs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model_linear_bg_after_onset_vectorargs</span><span class="p">(</span><span class="n">input_vector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to calculate the values given by</span>
<span class="sd">    rot_sym_with_replocs_and_substructure_isotropic_bg_after_onset, but using a</span>
<span class="sd">    vector input for the parameters, so that the numdifftools package can be</span>
<span class="sd">    used to calculate partial derivatives for correct error propagation in the</span>
<span class="sd">    model.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_vector (list or numpy array):</span>
<span class="sd">            A concatenation of:</span>
<span class="sd">                1.  A distance at which density values of the model will be</span>
<span class="sd">                obtained (numpy array)</span>

<span class="sd">                2. The parameters used by</span>
<span class="sd">                rot_sym_with_replocs_and_substructure_isotropic_bg_after_onset.</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model at the input</span>
<span class="sd">            distances (called separation_values_1d).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
     <span class="n">diameter</span><span class="p">,</span>
     <span class="n">vertices_broadening</span><span class="p">,</span> <span class="n">vertices_amplitude</span><span class="p">,</span>
     <span class="n">rept_locs_broadening</span><span class="p">,</span> <span class="n">rept_locs_amplitude</span><span class="p">,</span>
     <span class="n">substructure_broadening</span><span class="p">,</span> <span class="n">substructure_amplitude</span><span class="p">,</span>
     <span class="n">bg_grad</span><span class="p">,</span> <span class="n">bg_onset</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_vector</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rot_sym_with_replocs_and_substructure_isotropic_bg_after_onset</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                                         <span class="n">diameter</span><span class="p">,</span>
                                                                         <span class="n">vertices_broadening</span><span class="p">,</span>
                                                                         <span class="n">vertices_amplitude</span><span class="p">,</span>
                                                                         <span class="n">rept_locs_broadening</span><span class="p">,</span>
                                                                         <span class="n">rept_locs_amplitude</span><span class="p">,</span>
                                                                         <span class="n">substructure_broadening</span><span class="p">,</span>
                                                                         <span class="n">substructure_amplitude</span><span class="p">,</span>
                                                                         <span class="n">bg_grad</span><span class="p">,</span>
                                                                         <span class="n">bg_onset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="model_variable_vertices_replocs_substructure_no_bg">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.model_variable_vertices_replocs_substructure_no_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model_variable_vertices_replocs_substructure_no_bg</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span>
        <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for distances between localisations on vertices</span>
<span class="sd">    of a polygon (order of symmetry = number of vertices). The value of</span>
<span class="sd">    the model at a distance is termed the relative position density (RPD)</span>
<span class="sd">    at that distance. Includes the effect of localisation precision and</span>
<span class="sd">    unresolvable substructure at the polygon vertices.</span>

<span class="sd">    In this model, the inter-vertex distances are allowed to have independent</span>
<span class="sd">    amplitude in the RPD.</span>

<span class="sd">    Args:</span>
<span class="sd">        separation_values (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        diameter (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertssd (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">            distances between the vertices.</span>
<span class="sd">        vertamp1, vertamp2, vertamp3, vertamp4 (float):</span>
<span class="sd">            Amplitudes of the contributions of the different inter-vertex</span>
<span class="sd">            distances.</span>
<span class="sd">        replocssd (float):</span>
<span class="sd">            Spread representing localisation precision for repeated</span>
<span class="sd">            localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">            of the same fluorescent molecule.</span>
<span class="sd">        substructsd (float):</span>
<span class="sd">            Spread of a contribution resulting from unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructamp (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">           The relative position density given by the model</span>
<span class="sd">           at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare amplitudes of the different inter-vertex distances</span>
    <span class="c1"># for easy use.</span>
    <span class="n">vertices_contributions</span> <span class="o">=</span> <span class="p">[</span><span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">]</span>

    <span class="c1"># Calculate the inter-vertex distances</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">generate_polygon_points</span><span class="p">(</span><span class="n">sym_order</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>

    <span class="n">filter_distance</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">diameter</span>
    <span class="n">relative_positions</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">filter_distance</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xy_separations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                             <span class="o">+</span> <span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Select unduplicated inter-vertex distances</span>
    <span class="c1"># (round down from # vertices divided by 2).</span>
    <span class="n">xy_separations</span> <span class="o">=</span> <span class="n">xy_separations</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sym_order</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))]</span>

    <span class="c1"># Include the contributions from the inter-vertex distance in the RPD.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">separation_values</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xy_separations</span><span class="p">):</span>
        <span class="n">rpd</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpd</span>
               <span class="o">+</span> <span class="n">vertices_contributions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
               <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                <span class="n">distance</span><span class="p">,</span>
                                                <span class="n">vertssd</span>
                                                <span class="p">)</span>
               <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">replocsamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="get_1sd_error_on_model_before_and_after_background_onset">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.get_1sd_error_on_model_before_and_after_background_onset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_1sd_error_on_model_before_and_after_background_onset</span><span class="p">(</span>
        <span class="n">x_values</span><span class="p">,</span>
        <span class="n">params_optimised</span><span class="p">,</span>
        <span class="n">params_covar</span><span class="p">,</span>
        <span class="n">bg_onset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use stdev_of_models in modelling_general (uses numdifftools) to acquire</span>
<span class="sd">    stdev of the models before and after the background onset distance, and</span>
<span class="sd">    concatenate to provide output.</span>

<span class="sd">    Args:</span>
<span class="sd">        x_values (numpy array):</span>
<span class="sd">            Distances at which the models are evaluated.</span>
<span class="sd">        params_optimised (numpy array):</span>
<span class="sd">            The optimised parameter values for</span>
<span class="sd">            rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset</span>
<span class="sd">            in rotationalsymettrymodelling, following a fit to</span>
<span class="sd">            experimental data.</span>
<span class="sd">        params_covar (numpy array):</span>
<span class="sd">            The covariance matrix for the parameters that have been optimised.</span>
<span class="sd">        vector_input_model (function):</span>
<span class="sd">            The name of a function that will be passed to</span>
<span class="sd">            numdifftools.Gradient. This function must have one arguments, which</span>
<span class="sd">            is a vector. The first element of the vector is also the vector of</span>
<span class="sd">            x_values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        stdev_complete (numpy array):</span>
<span class="sd">            Numpy array of 1 standard deviation of uncertainty on the model</span>
<span class="sd">            evaluated at each x_value.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_values_before_onset</span> <span class="o">=</span> <span class="n">x_values</span><span class="p">[</span><span class="n">x_values</span> <span class="o">&lt;=</span> <span class="n">bg_onset</span><span class="p">]</span>
    <span class="n">x_values_after_onset</span> <span class="o">=</span> <span class="n">x_values</span><span class="p">[</span><span class="n">x_values</span> <span class="o">&gt;</span> <span class="n">bg_onset</span><span class="p">]</span>

    <span class="c1"># Use fitted parameters from</span>
    <span class="c1"># rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset</span>
    <span class="c1"># in rotationalsymettrymodelling, except for background (final two)</span>
    <span class="c1"># parameters</span>
    <span class="n">stdev_before_onset</span> <span class="o">=</span> <span class="n">stdev_of_model</span><span class="p">(</span><span class="n">x_values_before_onset</span><span class="p">,</span>
                                        <span class="n">params_optimised</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="n">params_covar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="n">model_replocs_substruct_no_bg_vectorargs</span>
                                        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculated stdev before background onset.&#39;</span><span class="p">)</span>

    <span class="c1"># Use fitted parameters from</span>
    <span class="c1"># rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset</span>
    <span class="n">stdev_after_onset</span> <span class="o">=</span> <span class="n">stdev_of_model</span><span class="p">(</span><span class="n">x_values_after_onset</span><span class="p">,</span>
                                       <span class="n">params_optimised</span><span class="p">,</span>
                                       <span class="n">params_covar</span><span class="p">,</span>
                                       <span class="n">model_linear_bg_after_onset_vectorargs</span>
                                       <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculated stdev after background onset.&#39;</span><span class="p">)</span>

    <span class="n">stdev_complete</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdev_before_onset</span><span class="p">,</span> <span class="n">stdev_after_onset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stdev_complete</span></div>



<div class="viewcode-block" id="nup_xy_fig_plot">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.nup_xy_fig_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nup_xy_fig_plot</span><span class="p">(</span>
        <span class="n">relative_position_array</span><span class="p">,</span>
        <span class="n">model_with_info</span><span class="p">,</span>
        <span class="n">fitlength</span><span class="o">=</span><span class="mf">200.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a plot showing optimised model and uncertainties from fitting</span>
<span class="sd">    hard-onset Nup107 model.</span>

<span class="sd">    Args:</span>
<span class="sd">        relative_position_array (numpy array):</span>
<span class="sd">            Numpy array of relative positions vectors. First two columns</span>
<span class="sd">            are X and Y components of relative positions.</span>
<span class="sd">        model:</span>
<span class="sd">            A function. The parametric RPD model.</span>
<span class="sd">        fitlength (scalar):</span>
<span class="sd">            The extent across the XY plane within which</span>
<span class="sd">            relative positions are included in the histogram, fitting</span>
<span class="sd">            and plotting.</span>
<span class="sd">    Returns:</span>
<span class="sd">        stdev (numpy array):</span>
<span class="sd">            The uncertainties on the model at each separation used in the fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">xy_histogram</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">make_xy_histogram_nm</span><span class="p">(</span><span class="n">relative_position_array</span><span class="p">,</span>
                                               <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">,</span>
                                               <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
     <span class="n">params_covar</span><span class="p">,</span>
     <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span><span class="n">xy_histogram</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
                                                        <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">)</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fitlength</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                                  <span class="o">*</span><span class="n">params_optimised</span>
                                                  <span class="p">),</span>
              <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:red&#39;</span>
              <span class="p">)</span>

    <span class="c1"># Find background onset distance from the optimised parameters</span>
    <span class="n">bg_onset</span> <span class="o">=</span> <span class="n">params_optimised</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get uncertainties below and above background onset and concatenate</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">get_1sd_error_on_model_before_and_after_background_onset</span><span class="p">(</span>
                <span class="n">x_values</span><span class="p">,</span>
                <span class="n">params_optimised</span><span class="p">,</span>
                <span class="n">params_covar</span><span class="p">,</span>
                <span class="n">bg_onset</span>
                <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculated stdev for whole model.&#39;</span><span class="p">)</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                                 <span class="o">*</span><span class="n">params_optimised</span>
                                                 <span class="p">)</span>
                       <span class="o">-</span> <span class="n">stdev</span> <span class="o">*</span> <span class="mf">1.96</span>
                       <span class="p">),</span>
                      <span class="p">(</span><span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                                 <span class="o">*</span><span class="n">params_optimised</span>
                                                 <span class="p">)</span>
                       <span class="o">+</span> <span class="n">stdev</span> <span class="o">*</span> <span class="mf">1.96</span>
                       <span class="p">),</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span>
                      <span class="p">)</span>

    <span class="k">return</span> <span class="n">bg_onset</span><span class="p">,</span> <span class="n">stdev</span></div>



<div class="viewcode-block" id="nup_xy_plot_model_components">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.nup_xy_plot_model_components">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nup_xy_plot_model_components</span><span class="p">(</span>
        <span class="n">relpos</span><span class="p">,</span>
        <span class="n">model_with_info</span><span class="p">,</span>
        <span class="n">fitlength</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a plot</span>
<span class="sd">    Args:</span>
<span class="sd">        relpos:</span>
<span class="sd">        model:</span>
<span class="sd">        fitlength:</span>
<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">xy_histogram</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">make_xy_histogram_nm</span><span class="p">(</span><span class="n">relpos</span><span class="p">,</span>
                                               <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">,</span>
                                               <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
     <span class="n">params_covar</span><span class="p">,</span>
     <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span><span class="n">xy_histogram</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
                                                        <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
                                                        <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">)</span>
    <span class="n">dia</span><span class="p">,</span>\
    <span class="n">vertssd</span><span class="p">,</span> <span class="n">vertsamp</span><span class="p">,</span>\
    <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>\
    <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>\
    <span class="n">bggrad</span><span class="p">,</span> <span class="n">bgonset</span>\
    <span class="o">=</span> <span class="n">params_optimised</span>

    <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fitlength</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="c1"># Plot fitted model curve</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="o">*</span><span class="n">params_optimised</span><span class="p">))</span>
    <span class="c1"># Plot localisation precision component</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
              <span class="n">replocsamp</span>
              <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                               <span class="mf">0.</span><span class="p">,</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span>
                                               <span class="p">)</span>
              <span class="p">)</span>
    <span class="c1"># Plot substructure component</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
              <span class="n">substructamp</span>
              <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                               <span class="mf">0.</span><span class="p">,</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span>
                                               <span class="p">)</span>
              <span class="p">)</span>
    <span class="c1"># Plot symmetry related peaks</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">generate_polygon_points</span><span class="p">(</span><span class="n">sym_order</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">dia</span><span class="p">)</span>
    <span class="n">filterdist</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dia</span>

    <span class="n">relpos</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">filterdist</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">relpos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">relpos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># Select unduplicated distances between the vertices.</span>
    <span class="n">contributions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">peak</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dists</span><span class="p">):</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                  <span class="n">vertsamp</span> <span class="o">*</span> <span class="n">contributions</span><span class="p">[</span><span class="n">peak</span><span class="p">]</span>
                  <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">vertssd</span><span class="p">))</span>

    <span class="c1"># Plot background</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">x_values</span> <span class="o">*</span> <span class="n">bggrad</span> <span class="o">-</span> <span class="n">bggrad</span> <span class="o">*</span> <span class="n">bgonset</span>
    <span class="n">background</span><span class="p">[</span><span class="n">background</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">background</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">])</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;XY-separation (nm)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts (scaled)&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_default_fitting_params_dicts">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.create_default_fitting_params_dicts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_default_fitting_params_dicts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create lists for initial guesses and bounds for parameters during</span>
<span class="sd">    fitting. Sets the defaults for scipy.optimise.curve_fit</span>

<span class="sd">    Returns:</span>
<span class="sd">        lower_bound_dict (dict):</span>
<span class="sd">            Dictionary of default lower bound options for parameter values.</span>
<span class="sd">        upper_bound_dict (dict):</span>
<span class="sd">            Dictionary of default upper bound options for parameter values.</span>
<span class="sd">        initial_params_dict (dict):</span>
<span class="sd">            Dictionary of default initial parameter value options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lower_bound_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertices_sd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertices_amp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_3&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_4&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;substruct_sd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;substruct_amp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_slope&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_onset&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_variation&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_dia&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_amp&#39;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>

    <span class="n">upper_bound_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="mf">200.</span><span class="p">,</span>
                        <span class="s1">&#39;vertices_sd&#39;</span><span class="p">:</span> <span class="mf">50.</span><span class="p">,</span>
                        <span class="s1">&#39;vertices_amp&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_1&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_2&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_3&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span>
                        <span class="s1">&#39;vertex_amp_4&#39;</span><span class="p">:</span> <span class="mf">500.</span><span class="p">,</span>
                        <span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">:</span> <span class="mf">50.</span><span class="p">,</span>
                        <span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">:</span> <span class="mf">50.</span><span class="p">,</span>
                        <span class="s1">&#39;substruct_sd&#39;</span><span class="p">:</span> <span class="mf">50.</span><span class="p">,</span>
                        <span class="s1">&#39;substruct_amp&#39;</span><span class="p">:</span> <span class="mf">50.</span><span class="p">,</span>
                        <span class="s1">&#39;bg_slope&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                        <span class="s1">&#39;bg_onset&#39;</span><span class="p">:</span> <span class="mf">150.</span><span class="p">,</span>
                        <span class="s1">&#39;bg_variation&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                        <span class="s1">&#39;bg_dia&#39;</span><span class="p">:</span> <span class="mf">1000.</span><span class="p">,</span>
                        <span class="s1">&#39;bg_amp&#39;</span><span class="p">:</span> <span class="mf">100.</span>
                        <span class="p">}</span>

    <span class="n">initial_params_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                           <span class="s1">&#39;vertices_sd&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
                           <span class="s1">&#39;vertices_amp&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
                           <span class="s1">&#39;vertex_amp_1&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                           <span class="s1">&#39;vertex_amp_2&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                           <span class="s1">&#39;vertex_amp_3&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                           <span class="s1">&#39;vertex_amp_4&#39;</span><span class="p">:</span> <span class="mf">100.</span><span class="p">,</span>
                           <span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">:</span> <span class="mf">3.</span><span class="p">,</span>
                           <span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
                           <span class="s1">&#39;substruct_sd&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
                           <span class="s1">&#39;substruct_amp&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
                           <span class="s1">&#39;bg_slope&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                           <span class="s1">&#39;bg_onset&#39;</span><span class="p">:</span> <span class="mf">50.</span><span class="p">,</span>
                           <span class="s1">&#39;bg_variation&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                           <span class="s1">&#39;bg_dia&#39;</span><span class="p">:</span> <span class="mf">300.</span><span class="p">,</span>
                           <span class="s1">&#39;bg_amp&#39;</span><span class="p">:</span> <span class="mf">10.</span>
                           <span class="p">}</span>

    <span class="k">return</span> <span class="n">lower_bound_dict</span><span class="p">,</span> <span class="n">upper_bound_dict</span><span class="p">,</span> <span class="n">initial_params_dict</span></div>



<div class="viewcode-block" id="set_up_model_replocs_substruct_iso_bg_with_onset_with_fit_settings">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.set_up_model_replocs_substruct_iso_bg_with_onset_with_fit_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_up_model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the RPD model with fitting settings,</span>
<span class="sd">    for a rotationally symmetric model with spread due to repeated</span>
<span class="sd">    localisations, spread to unresolvable substructure, and a background</span>
<span class="sd">    that increases linearly after an onset distance.</span>
<span class="sd">    The fitting settings are to pass to scipy&#39;s</span>
<span class="sd">    curve_fit, and the vector-input version of the model is for</span>
<span class="sd">    differentiation and error propagation with numdifftools.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ModelWithFitSettings object containing:</span>
<span class="sd">            model_rpd (function name):</span>
<span class="sd">                Relative position density as a function of separation</span>
<span class="sd">                between localisations.</span>
<span class="sd">            initial_params (list):</span>
<span class="sd">                Starting guesses for the parameter values by</span>
<span class="sd">                scipy.optimize.curve_fit</span>
<span class="sd">            lower_bounds (list), upper_bounds (list):</span>
<span class="sd">                The bounds on allowable parameter values as</span>
<span class="sd">                scipy.optimize.curve_fit runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate ModelWithFitSettings object, conatining a model_rpd</span>
    <span class="n">model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ModelWithFitSettings</span><span class="p">(</span>
            <span class="n">model_rpd</span><span class="o">=</span><span class="n">rot_sym_replocs_substructure_isotropic_bg_with_onset</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Add fitting parameters to ModelWithFitSettings object</span>
    <span class="p">(</span><span class="n">lower_bound_dict</span><span class="p">,</span>
     <span class="n">upper_bound_dict</span><span class="p">,</span>
     <span class="n">initial_params_dict</span><span class="p">)</span> <span class="o">=</span> <span class="n">create_default_fitting_params_dicts</span><span class="p">()</span>

    <span class="c1"># Can optionally modify these dictionaries here:</span>

    <span class="n">initial_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertices_sd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertices_amp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;substruct_sd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;substruct_amp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;bg_slope&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;bg_onset&#39;</span><span class="p">]</span>
                      <span class="p">]</span>

    <span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_sd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_amp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_sd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_amp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_slope&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_onset&#39;</span><span class="p">]</span>
                    <span class="p">]</span>

    <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_sd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_amp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_sd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_amp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_slope&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_onset&#39;</span><span class="p">]</span>
                    <span class="p">]</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bounds</span><span class="p">,</span> <span class="n">upper_bounds</span><span class="p">)</span>

    <span class="n">model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span><span class="o">.</span><span class="n">initial_params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">initial_params</span>
        <span class="p">)</span>
    <span class="n">model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span><span class="o">.</span><span class="n">param_bounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bounds</span>
        <span class="p">)</span>
    <span class="n">model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span><span class="o">.</span><span class="n">vector_input_model</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">rot_sym_with_replocs_and_substructure_isotropic_bg_with_onset_vectorargs</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span></div>



<div class="viewcode-block" id="set_up_model_replocs_substruct_no_bg_with_fit_settings">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.set_up_model_replocs_substruct_no_bg_with_fit_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_up_model_replocs_substruct_no_bg_with_fit_settings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the RPD model with fitting settings,</span>
<span class="sd">    for a rotationally symmetric model with spread due to repeated</span>
<span class="sd">    localisations and spread to unresolvable substructure.</span>
<span class="sd">    The fitting settings are to pass to scipy&#39;s</span>
<span class="sd">    curve_fit, and the vector-input version of the model is for</span>
<span class="sd">    differentiation and error propagation with numdifftools.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ModelWithFitSettings object containing:</span>
<span class="sd">            model_rpd (function name):</span>
<span class="sd">                Relative position density as a function of separation</span>
<span class="sd">                between localisations.</span>
<span class="sd">            initial_params (list):</span>
<span class="sd">                Starting guesses for the parameter values by</span>
<span class="sd">                scipy.optimize.curve_fit</span>
<span class="sd">            lower_bounds (list), upper_bounds (list):</span>
<span class="sd">                The bounds on allowable parameter values as</span>
<span class="sd">                scipy.optimize.curve_fit runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate ModelWithFitSettings object, conatining a model_rpd</span>
    <span class="n">model_replocs_substruct_no_bg_with_fit_settings</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ModelWithFitSettings</span><span class="p">(</span>
            <span class="n">model_rpd</span><span class="o">=</span><span class="n">model_replocs_substruct_no_bg</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Add fitting parameters to ModelWithFitSettings object</span>
    <span class="p">(</span><span class="n">lower_bound_dict</span><span class="p">,</span>
     <span class="n">upper_bound_dict</span><span class="p">,</span>
     <span class="n">initial_params_dict</span><span class="p">)</span> <span class="o">=</span> <span class="n">create_default_fitting_params_dicts</span><span class="p">()</span>

    <span class="c1"># Can optionally modify these dictionaries here:</span>

<span class="c1">#    initial_params = [initial_params_dict[&#39;diameter&#39;],</span>
<span class="c1">#                      initial_params_dict[&#39;vertices_sd&#39;],</span>
<span class="c1">#                      initial_params_dict[&#39;vertices_amp&#39;],</span>
<span class="c1">#                      initial_params_dict[&#39;loc_prec_sd&#39;],</span>
<span class="c1">#                      initial_params_dict[&#39;loc_prec_amp&#39;],</span>
<span class="c1">#                      initial_params_dict[&#39;substruct_sd&#39;],</span>
<span class="c1">#                      initial_params_dict[&#39;substruct_amp&#39;],</span>
<span class="c1">#                      ]</span>

    <span class="n">initial_params</span> <span class="o">=</span> <span class="p">[</span><span class="mf">300.0</span><span class="p">,</span> <span class="c1"># diameter</span>
                      <span class="mf">35.0</span><span class="p">,</span> <span class="c1"># vertssd</span>
                      <span class="mf">100.</span><span class="p">,</span> <span class="c1"># vertsamp</span>
                      <span class="mf">10.0</span><span class="p">,</span> <span class="c1"># replocssd</span>
                      <span class="mf">10.0</span><span class="p">,</span> <span class="c1"># replocsamp</span>
                      <span class="mf">10.</span><span class="p">,</span> <span class="c1"># substructsd</span>
                      <span class="mf">10.</span> <span class="c1"># substructamp</span>
                      <span class="p">]</span>

    <span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_sd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_amp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_sd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_amp&#39;</span><span class="p">],</span>
                    <span class="p">]</span>

    <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_sd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertices_amp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_sd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;loc_prec_amp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_sd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substruct_amp&#39;</span><span class="p">],</span>
                    <span class="p">]</span>

    <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">400.0</span><span class="p">,</span> <span class="c1"># diameter</span>
                    <span class="mf">1000.0</span><span class="p">,</span> <span class="c1"># vertssd</span>
                    <span class="mf">500.</span><span class="p">,</span> <span class="c1">#vertsamp</span>
                    <span class="mf">50.0</span><span class="p">,</span> <span class="c1"># replocssd</span>
                    <span class="mf">500.0</span><span class="p">,</span> <span class="c1"># replocsamp</span>
                    <span class="mf">50.</span><span class="p">,</span> <span class="c1"># substructsd</span>
                    <span class="mf">500.</span> <span class="c1"># substructamp</span>
                    <span class="p">]</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bounds</span><span class="p">,</span> <span class="n">upper_bounds</span><span class="p">)</span>

    <span class="n">model_replocs_substruct_no_bg_with_fit_settings</span><span class="o">.</span><span class="n">initial_params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">initial_params</span>
        <span class="p">)</span>
    <span class="n">model_replocs_substruct_no_bg_with_fit_settings</span><span class="o">.</span><span class="n">param_bounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bounds</span>
        <span class="p">)</span>
    <span class="n">model_replocs_substruct_no_bg_with_fit_settings</span><span class="o">.</span><span class="n">vector_input_model</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">model_replocs_substruct_no_bg_vectorargs</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">model_replocs_substruct_no_bg_with_fit_settings</span></div>




<span class="c1"># Set up callable symmetry order object, with default value</span>
<span class="n">sym_order</span> <span class="o">=</span> <span class="n">Number</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../perpl.html#perpl.rot_2d_symm_fit.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads input data of point density localisations that has been processed by the</span>
<span class="sd">    relative_positions.py script which calculates relative positions as</span>
<span class="sd">    vectors. These are compared to models of point density localisations with</span>
<span class="sd">    various levels of 2D rotational symmetry.</span>

<span class="sd">    Outputs are writen to a file in a directory with the name of the inputfile</span>
<span class="sd">    and a time stamp above the directory of the input file. There is an html</span>
<span class="sd">    report in this directory that provides information of how well each model</span>
<span class="sd">    fits the experimental data.</span>
<span class="sd">    If no input argments are provided inputs can be given from the command</span>
<span class="sd">    line as it executes.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_file (FILE): File of localisations which is a .csv file.</span>
<span class="sd">        filter_dist (int): The filter distance.</span>
<span class="sd">        verbose (Boolean): Increases the output to screen during execution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># handle the input arguments (flags)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="s1">&#39;rot_2d_symm_fit&#39;</span>
    <span class="n">prog_short_name</span> <span class="o">=</span> <span class="s1">&#39;r2dsf&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Fits rotational symmetry models to relative positions &#39;</span>
                   <span class="s1">&#39;among localisation microscopy data. The models are &#39;</span>
                   <span class="s1">&#39;generated from synthetic localisation data.&#39;</span><span class="p">)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prog&#39;</span><span class="p">:</span> <span class="n">prog</span><span class="p">,</span>
            <span class="s1">&#39;prog_short_name&#39;</span><span class="p">:</span> <span class="n">prog_short_name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">}</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H-%M-%S&#39;</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input_file&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;input_file&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;File of localisations which is a .csv (or .txt &#39;</span>
                             <span class="s1">&#39;with comma delimiters) or .npy and containing N &#39;</span>
                             <span class="s1">&#39;localisations in N rows.&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--filter_distance&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;filter_dist&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="c1"># default=150, PROBLEM LINE</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Filter distance.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--short_names&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Uses shortened names for the results files and &quot;</span>
                        <span class="s2">&quot;directories. While this makes the results less easy to&quot;</span>
                        <span class="s2">&quot; navigate it can be particularly useful on Windows&quot;</span>
                        <span class="s2">&quot; systems that do not allow long names and paths. &quot;</span>
                        <span class="s2">&quot;The input file name is used for the results filename&quot;</span>
                        <span class="s2">&quot; and this shortened names has the first and last 5&quot;</span>
                        <span class="s2">&quot; characters with -s- is the middle.&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Increase output verbosity&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">args: &quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verbosity is turned on.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filter_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">filter_dist</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;short_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">short_names</span>


    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">input_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">get_inputs</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;in_file_and_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">name</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ip_address&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;operating_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_hostname_and_ip</span><span class="p">()</span>

    <span class="n">read_start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">xyz_values</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">secondary_read_data_in</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="c1"># print(&quot;data read!!\n&quot;)</span>
    <span class="n">read_end</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">reading_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_end</span><span class="o">-</span><span class="n">read_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">secondary_filename_and_path_setup</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Time to read the input file was: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">reading_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">+</span>\
              <span class="s2">&quot; minutes.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This contains &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; xyz locations with &#39;</span>
              <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; columns.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;short_names&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;short_results_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected error:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not create directory for the results.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;results_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected error:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not create directory for the results.&quot;</span><span class="p">)</span>

    <span class="c1"># Get histogram data ready to fit to model</span>
    <span class="c1">#xy_histogram = models.make_xy_histogram_nm(xyz_values, fitlength=fitlength,</span>
    <span class="c1">#fig_toggle=False)[0]</span>
    <span class="n">xydists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xyz_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">xyz_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fitlength</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filter_dist&#39;</span><span class="p">]</span>
    <span class="n">bin_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fitlength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">xy_histogram</span><span class="p">,</span> <span class="n">bin_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">xydists</span><span class="p">,</span>
                                            <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fitlength</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">xydists</span><span class="p">),</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">xydists</span><span class="p">)),</span>
                                            <span class="n">bins</span><span class="o">=</span><span class="n">bin_vals</span><span class="p">)</span>


    <span class="c1"># Define symmetries over which to perform and evaluate fit</span>
    <span class="n">symmetries</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

    <span class="c1"># Prepare to record fit metric (AICc)</span>
    <span class="n">aiccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symmetries</span><span class="p">))</span>


    <span class="c1"># Define model, including parameter guesses and bounds to pass to</span>
    <span class="c1"># scipy.optimize.curve_fit</span>
    <span class="n">model_with_info</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">set_up_model_replocs_substruct_iso_bg_with_onset_with_fit_settings</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="o">.</span><span class="vm">__name__</span>


    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;optimisation_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span>


    <span class="n">curve_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">diameter_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">table_param_values</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symmetries</span><span class="p">):</span>
        <span class="n">sym_order</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">sym</span>

        <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
         <span class="n">params_covar</span><span class="p">,</span>
         <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span><span class="n">xy_histogram</span><span class="p">,</span>
                                                            <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                                                            <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
                                                            <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
                                                            <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">)</span>
        <span class="n">aicc</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">aic_from_least_sqr_fit</span><span class="p">(</span><span class="n">xy_histogram</span><span class="p">,</span>
                                            <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                                            <span class="n">params_optimised</span><span class="p">,</span>
                                            <span class="n">fitlength</span><span class="o">=</span><span class="n">fitlength</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">aiccs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aicc</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fitlength</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">diameter_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params_optimised</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">curve_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="o">*</span><span class="n">params_optimised</span><span class="p">))</span>


        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Symmetry:&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameter    Optimised Value&quot;</span><span class="p">)</span>

        <span class="n">param_string_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">uncertainty_string_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">param_optimised</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params_optimised</span><span class="p">):</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">params_1sd_error</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">param_optimised</span>

            <span class="n">value_str</span><span class="p">,</span> <span class="n">uncertainty_str</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">plus_and_minus</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">)</span>

            <span class="n">param_string_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="n">uncertainty_string_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uncertainty_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">            </span><span class="si">{</span><span class="n">value_str</span><span class="si">}</span><span class="s1"> +/- </span><span class="si">{</span><span class="n">uncertainty_str</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>


        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">params_optimised</span><span class="p">,</span>
                                  <span class="n">params_1sd_error</span><span class="p">,</span>
                                  <span class="n">param_string_values</span><span class="p">,</span>
                                  <span class="n">uncertainty_string_values</span><span class="p">))</span>


        <span class="n">table_param_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">plotting</span><span class="o">.</span><span class="n">plot_histogram_with_curves</span><span class="p">(</span><span class="n">bin_values</span><span class="p">,</span>
                                        <span class="n">xy_histogram</span><span class="p">,</span>
                                        <span class="n">symmetries</span><span class="p">,</span>
                                        <span class="n">x_values</span><span class="p">,</span>
                                        <span class="n">curve_values</span><span class="p">,</span>
                                        <span class="n">info</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symmetries</span><span class="p">):</span>
        <span class="n">sym_order</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">sym</span>
        <span class="n">plotting</span><span class="o">.</span><span class="n">plot_rot_2d_geometry</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">diameter_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">info</span><span class="p">)</span>


    <span class="n">weights</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">akaike_weights</span><span class="p">(</span><span class="n">aiccs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Symmetry</span><span class="se">\t</span><span class="s1">AICc</span><span class="se">\t\t</span><span class="s1">Akaike weight&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">symmetry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symmetries</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symmetry</span><span class="si">:</span><span class="s1">2d</span><span class="si">}</span><span class="se">\t\t</span><span class="si">{</span><span class="n">aiccs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="si">{</span><span class="n">weights</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">:</span><span class="s1">.2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="n">reports</span><span class="o">.</span><span class="n">write_rot_2d_html_report</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">,</span> <span class="n">aiccs</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">table_param_values</span><span class="p">)</span></div>





<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1">#Tk().withdraw()</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="c1">#print(&#39;\nHit Enter to exit&#39;)</span>
    <span class="c1">#input()</span>
    
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PERPL</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">perpl</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Alistair Curd.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>