<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>perpl.modelling.centriole_analysis &#8212; PERPL  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for perpl.modelling.centriole_analysis</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">centriole_analysis.py</span>

<span class="sd">Created on Tue Sep 25 12:00:00 2019</span>

<span class="sd">Functions for analysing segmented top-view centriolar protein localisations.</span>

<span class="sd">Alistair Curd</span>
<span class="sd">University of Leeds</span>
<span class="sd">16 September 2019</span>

<span class="sd">---</span>
<span class="sd">Copyright 2019 Peckham Lab</span>

<span class="sd">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use</span>
<span class="sd">this file except in compliance with the License. You may obtain a copy of the</span>
<span class="sd">License at</span>
<span class="sd">http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">Unless required by applicable law or agreed to in writing, software distributed</span>
<span class="sd">under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="sd">CONDITIONS OF ANY KIND, either express or implied. See the License for the</span>
<span class="sd">specific language governing permissions and limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">loadmat</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">perpl.modelling.modelling_general</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.modelling.modelling_general</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelWithFitSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">relative_positions</span><span class="w"> </span><span class="kn">import</span> <span class="n">getdistances</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">perpl.modelling.background_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">pair_correlation_disk</span>


<div class="viewcode-block" id="get_input_data">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.get_input_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_input_data</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s1">&#39;S:/Peckham/Bioimaging2/Alistair/Centriole-EPFL&#39;</span>
                          <span class="s1">&#39;/forAlistair_310718/Cep152_A647_Top.mat&#39;</span>
                   <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Import and extract a list of dSTORM data on centrioles</span>
<span class="sd">    from Christian Sieben&#39;s MATLAB file.</span>

<span class="sd">    Args:</span>
<span class="sd">        infile (string):</span>
<span class="sd">            The path to the data to be extracted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        simul (list of numpy arrays):</span>
<span class="sd">            A list of arrays of dSTORM localisations, one element per</span>
<span class="sd">            centriole.</span>
<span class="sd">            For each centriole, columns [0] and [1] of the array</span>
<span class="sd">            are (x, y) for each localisation; column [3] is estimated</span>
<span class="sd">            localisation precision in nm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import centriole localisations</span>
    <span class="n">epfl_matlab_centrioles</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">epfl_matlab_centrioles</span> <span class="o">=</span> <span class="n">epfl_matlab_centrioles</span><span class="p">[</span><span class="s1">&#39;Predicted_Top&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">epfl_matlab_centrioles</span></div>



<div class="viewcode-block" id="reconstruct_centrioles">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.reconstruct_centrioles">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_centrioles</span><span class="p">(</span><span class="n">centriole_localisation_data</span><span class="p">,</span>
                           <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">binsize_nm</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                           <span class="n">smoothing_nm</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produces centriole reconstructions from localisation data and plots</span>
<span class="sd">    if desired.</span>

<span class="sd">    Args:</span>
<span class="sd">        centriole_localisation_data (list of numpy arrays):</span>
<span class="sd">            A list of arrays of dSTORM localisations, one element per</span>
<span class="sd">            centriole.</span>
<span class="sd">            For each centriole, columns [0] and [1] of the array</span>
<span class="sd">            are (x, y) for each localisation.</span>
<span class="sd">        index (list):</span>
<span class="sd">            If desired, the inidices of selected centrioles in the list.</span>
<span class="sd">            If not specified, a reconstruction is produced for all centrioles.</span>
<span class="sd">        plot (Boolean):</span>
<span class="sd">            Choose whether plots will be produced of each centriole.</span>
<span class="sd">        binsize_nm (float):</span>
<span class="sd">            The pixel size in the reconstructions, in nm.</span>
<span class="sd">        smoothing_nm (float):</span>
<span class="sd">            The kernal for Gaussian smoothing of the histogram, in nm.</span>

<span class="sd">    Returns:</span>
<span class="sd">        indices (list of integers):</span>
<span class="sd">            Indices of the chosen centrioles for reconstruction.</span>
<span class="sd">        list_of_reconstructions (list of 2D numpy arrays):</span>
<span class="sd">            Reconstructions of the centrioles, one centriole per list</span>
<span class="sd">            element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Choose all centrioles if none weere specified</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centriole_localisation_data</span><span class="p">))</span>

    <span class="c1"># Make and store reconstructions in list</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_of_reconstructions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
        <span class="c1"># Get x and y data for the localisations</span>
        <span class="n">locs_x</span> <span class="o">=</span> <span class="n">centriole_localisation_data</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">locs_y</span> <span class="o">=</span> <span class="n">centriole_localisation_data</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Make reconstruction.</span>
        <span class="c1"># Extend plot by 4 * Gaussian smoothing kernel beyond extreme</span>
        <span class="c1"># coordinates.</span>
        <span class="n">bin_edges_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">locs_x</span><span class="p">)</span> <span class="o">-</span> <span class="n">smoothing_nm</span> <span class="o">*</span> <span class="mf">4.</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">locs_x</span><span class="p">)</span> <span class="o">-</span> <span class="n">smoothing_nm</span> <span class="o">*</span> <span class="mf">4.</span><span class="p">,</span>
                                <span class="n">binsize_nm</span><span class="p">)</span>
        <span class="n">bin_edges_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">locs_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">smoothing_nm</span> <span class="o">*</span> <span class="mf">4.</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">locs_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">smoothing_nm</span> <span class="o">*</span> <span class="mf">4.</span><span class="p">,</span>
                                <span class="n">binsize_nm</span><span class="p">)</span>
        <span class="n">reconstruction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">locs_x</span><span class="p">,</span> <span class="n">locs_y</span><span class="p">,</span>
                                        <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">,</span> <span class="n">bin_edges_y</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Do smoothing by one pixel</span>
        <span class="n">reconstruction</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">smoothing_in_pixels</span> <span class="o">=</span> <span class="n">smoothing_nm</span> <span class="o">/</span> <span class="n">binsize_nm</span>
        <span class="n">reconstruction</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span>
                                         <span class="n">sigma</span><span class="o">=</span><span class="n">smoothing_in_pixels</span><span class="p">)</span>

        <span class="c1"># Append centriole number and reconstruction to list</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">list_of_reconstructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span>

        <span class="c1"># Plot if desired</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">indices</span><span class="p">,</span> <span class="n">list_of_reconstructions</span></div>



<span class="c1"># getdistances took 139 s to run centriole [0] (filterdist=1000.)</span>
<div class="viewcode-block" id="get_xy_distances">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.get_xy_distances">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_xy_distances</span><span class="p">(</span><span class="n">localisations_per_centriole</span><span class="p">,</span>
                     <span class="n">loc_precision_filter</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                     <span class="n">filter_distance</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span>
                     <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the XY between localisations in each centriole,</span>
<span class="sd">    filtered by localisation precision.</span>

<span class="sd">    Args:</span>
<span class="sd">        centriole_localisations (list of numpy arrays):</span>
<span class="sd">            A list of arrays of dSTORM localisations, one element per</span>
<span class="sd">            centriole.</span>
<span class="sd">            For each centriole, columns [0] and [1] of the array</span>
<span class="sd">            are (x, y) for each localisation; column [3] is estimated</span>
<span class="sd">            localisation precision in nm.</span>
<span class="sd">        loc_precision_filter (float):</span>
<span class="sd">            Upper limit on estimated localisation precision. Localisations</span>
<span class="sd">            with an estimate above this value will not be included.</span>
<span class="sd">        filter_distance (float):</span>
<span class="sd">            Required by relative_positions. Set to 1000 by default to</span>
<span class="sd">            comfortably include all distances in each centriole.</span>

<span class="sd">    Returns:</span>
<span class="sd">        distances_xy_per_centriole (list of numpy arrays):</span>
<span class="sd">            List containing the XY-distances found within each</span>
<span class="sd">            centriole, one centriole per list item.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distances_xy_per_centriole</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">centriole</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">localisations_per_centriole</span><span class="p">):</span>
        <span class="c1"># Filter imprecise localisations, and use only X and Y</span>
        <span class="n">filtered_locs</span> <span class="o">=</span> <span class="n">centriole</span><span class="p">[</span><span class="n">centriole</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
                                  <span class="o">&lt;</span> <span class="n">loc_precision_filter</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Analysing &#39;</span>
              <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_locs</span><span class="p">))</span>
              <span class="o">+</span> <span class="s1">&#39; localisations in centriole &#39;</span>
              <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="c1"># Get relative positions, using a filter distance large enough</span>
        <span class="c1"># to include the whole centriole</span>
        <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">filtered_locs</span><span class="p">,</span> <span class="n">filterdist</span><span class="o">=</span><span class="n">filter_distance</span><span class="p">)</span>
        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span>
              <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">))</span>
              <span class="o">+</span> <span class="s1">&#39; relative positions for centriole &#39;</span>
              <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">localisations_per_centriole</span><span class="p">))</span>
              <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;after &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">time_elapsed</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; s.&#39;</span><span class="p">,</span>
              <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Get distances across XY and append to the per-centriole list</span>
        <span class="n">distances_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">rel_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">distances_xy_per_centriole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distances_xy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distances_xy_per_centriole</span></div>



<div class="viewcode-block" id="make_distance_histogram">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.make_distance_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_distance_histogram</span><span class="p">(</span><span class="n">distance_values</span><span class="p">,</span>
                            <span class="n">max_distance</span><span class="p">,</span>
                            <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate distance histogram bin values, in bins of 1 nm,</span>
<span class="sd">    upto a maximum distance. Bin values will be normalised so that</span>
<span class="sd">    their mean is 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        distance_values (numpy array):</span>
<span class="sd">            Distances between localisations in a centriole</span>
<span class="sd">        max_distance (float):</span>
<span class="sd">            Upper limit on distnaces included in the histogram.</span>
<span class="sd">        normalise (bool):</span>
<span class="sd">            Decide whether to normalise the histograms so that the mean</span>
<span class="sd">            bin value is 1 (good for scipy&#39;s curve_fit on individual</span>
<span class="sd">            centriole data).</span>

<span class="sd">    Returns:</span>
<span class="sd">        hist (numpy array):</span>
<span class="sd">            Distance histogram bin values, normalised so that the mean is 1.</span>
<span class="sd">        bin_edges (numpy array):</span>
<span class="sd">            Distance histogram bin edge locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_distance</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalise</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">distance_values</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_distance</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">distance_values</span><span class="p">),</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">distance_values</span><span class="p">)</span>
                              <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">distance_values</span><span class="p">,</span>
                                       <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span>
                                       <span class="p">)</span>

    <span class="k">return</span> <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span></div>



<div class="viewcode-block" id="make_distance_histograms_per_centriole">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.make_distance_histograms_per_centriole">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_distance_histograms_per_centriole</span><span class="p">(</span><span class="n">distances_per_centriole</span><span class="p">,</span>
                                           <span class="n">max_distance</span><span class="p">,</span>
                                           <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a distance histogram for each centriole.</span>

<span class="sd">    Args:</span>
<span class="sd">        distances per_centriole (list of numpy arrays):</span>
<span class="sd">            List containing the XY-distances found within each</span>
<span class="sd">            centriole, one centriole per list item.</span>
<span class="sd">        max_distance (float):</span>
<span class="sd">            Upper limit on distaces included in the histograms.</span>
<span class="sd">        normalise (bool):</span>
<span class="sd">            Decide whether to normalise the histograms so that the mean</span>
<span class="sd">            bin value is 1 (good for scipy&#39;s curve_fit on individual</span>
<span class="sd">            centriole data).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dist_hist_list (2D numpy array):</span>
<span class="sd">            A list of distance histogram bin values; each row contains</span>
<span class="sd">            the distance histogram for one centriole.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist_hist_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">distances</span> <span class="ow">in</span> <span class="n">distances_per_centriole</span><span class="p">:</span>
        <span class="n">hist_values</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">make_distance_histogram</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span>
                                                         <span class="n">max_distance</span><span class="p">,</span>
                                                         <span class="n">normalise</span><span class="p">)</span>
        <span class="n">dist_hist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist_hist_list</span><span class="p">,</span> <span class="n">bin_edges</span></div>



<div class="viewcode-block" id="plot_distance_histogram">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.plot_distance_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_distance_histogram</span><span class="p">(</span><span class="n">histogram_values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot distance histogram.</span>

<span class="sd">    Args:</span>
<span class="sd">        histogram_values (numpy array):</span>
<span class="sd">            Histogram bin values.</span>
<span class="sd">        bin_edges (numpy array):</span>
<span class="sd">            Histogram bin edge locations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        axes:</span>
<span class="sd">            Matplotlib Axes instance containing the histogram plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up the plotting area</span>
    <span class="n">fig_histogram</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                               <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span>
                               <span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">fig_histogram</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="c1"># Set up and create the histogram plot</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">histogram_values</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span>
             <span class="p">)</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;XY-separation (nm)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts (normalised)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig_histogram</span><span class="p">,</span> <span class="n">axes</span></div>



<div class="viewcode-block" id="plot_95_ci">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.plot_95_ci">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_95_ci</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span>
               <span class="n">x_values</span><span class="p">,</span>
               <span class="n">model</span><span class="p">,</span>
               <span class="n">params_optimised</span><span class="p">,</span>
               <span class="n">params_covar</span><span class="p">,</span>
               <span class="n">vector_input_model</span>
               <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot 95% confidence interval for a fitted model.</span>

<span class="sd">    Args:</span>
<span class="sd">        axes:</span>
<span class="sd">            matplotlib Axes on which to plot the CI.</span>
<span class="sd">        x_values (numpy array):</span>
<span class="sd">            x-values at which to calculate and plot the CI.</span>
<span class="sd">        model (function name):</span>
<span class="sd">            The parametric model optimised to fit experimental data.</span>
<span class="sd">        params_optimised (numpy array):</span>
<span class="sd">            The optimised parameters for the fitted model.</span>
<span class="sd">        params_covar (numpy array):</span>
<span class="sd">            The covariance matrix for the fitted parameters.</span>
<span class="sd">        vector_input_model (function name):</span>
<span class="sd">            The version of the parametric model with input required to be a</span>
<span class="sd">            vector of the parameter values, for differentiation and error</span>
<span class="sd">            propagation with numdifftools.</span>

<span class="sd">    Returns:</span>
<span class="sd">        stdev (numpy array):</span>
<span class="sd">            Standard deviation of the model estimate at each x_value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get SD of model at the x-values</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">stdev_of_model</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                  <span class="n">params_optimised</span><span class="p">,</span>
                                  <span class="n">params_covar</span><span class="p">,</span>
                                  <span class="n">vector_input_model</span>
                                  <span class="p">)</span>

    <span class="c1"># Plot 95% CI</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                      <span class="n">model</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="o">*</span><span class="n">params_optimised</span><span class="p">)</span> <span class="o">-</span> <span class="n">stdev</span> <span class="o">*</span> <span class="mf">1.96</span><span class="p">,</span>
                      <span class="n">model</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="o">*</span><span class="n">params_optimised</span><span class="p">)</span> <span class="o">+</span> <span class="n">stdev</span> <span class="o">*</span> <span class="mf">1.96</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span>
                      <span class="p">)</span>

    <span class="k">return</span> <span class="n">stdev</span></div>



<div class="viewcode-block" id="plot_95_ci_internal_bg">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.plot_95_ci_internal_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_95_ci_internal_bg</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span>
                           <span class="n">x_values</span><span class="p">,</span>
                           <span class="n">model</span><span class="p">,</span>
                           <span class="n">params_optimised</span><span class="p">,</span>
                           <span class="n">params_covar</span><span class="p">,</span>
                           <span class="n">bg_dia</span><span class="p">,</span>
                           <span class="n">vector_input_model_below_bg_dia</span><span class="p">,</span>
                           <span class="n">vector_input_model_above_bg_dia</span>
                           <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot 95% confidence interval for a fitted model with internal</span>
<span class="sd">    background. This requires splitting into below and above the diameter</span>
<span class="sd">    of the background disk</span>

<span class="sd">    Args:</span>
<span class="sd">        axes:</span>
<span class="sd">            matplotlib Axes on which to plot the CI.</span>
<span class="sd">        x_values (numpy array):</span>
<span class="sd">            x-values at which to calculate and plot the CI.</span>
<span class="sd">        model (function name):</span>
<span class="sd">            The parametric model optimised to fit experimental data.</span>
<span class="sd">        params_optimised (numpy array):</span>
<span class="sd">            The optimised parameters for the fitted model.</span>
<span class="sd">        params_covar (numpy array):</span>
<span class="sd">            The covariance matrix for the fitted parameters.</span>
<span class="sd">        bg_dia (float):</span>
<span class="sd">            The diameter of the background disk of localisations.</span>
<span class="sd">        vector_input_model_below_bg_dia (function name):</span>
<span class="sd">            The version of the parametric model for separations less than</span>
<span class="sd">            the diameter of the background disk, with input required to be a</span>
<span class="sd">            vector of the parameter values, for differentiation and error</span>
<span class="sd">            propagation with numdifftools.</span>
<span class="sd">        vector_input_model_above_bg_dia (function name):</span>
<span class="sd">            The version of the parametric model for separations greater than</span>
<span class="sd">            the diameter of the background disk, with input required to be a</span>
<span class="sd">            vector of the parameter values, for differentiation and error</span>
<span class="sd">            propagation with numdifftools.</span>

<span class="sd">    Returns:</span>
<span class="sd">        stdev (numpy array):</span>
<span class="sd">            Standard deviation of the model estimate at each x_value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get SD of model at the x-values less than bg_dia</span>
    <span class="n">stdev_lower</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">stdev_of_model</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">x_values</span> <span class="o">&lt;</span> <span class="n">bg_dia</span><span class="p">],</span>
                                        <span class="n">params_optimised</span><span class="p">,</span>
                                        <span class="n">params_covar</span><span class="p">,</span>
                                        <span class="n">vector_input_model_below_bg_dia</span>
                                        <span class="p">)</span>

    <span class="c1"># Get SD of model at the x-values less than bg_dia</span>
    <span class="n">stdev_higher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">stdev_of_model</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">x_values</span> <span class="o">&gt;</span> <span class="n">bg_dia</span><span class="p">],</span>
                                         <span class="n">params_optimised</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="n">params_covar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="n">vector_input_model_above_bg_dia</span>
                                         <span class="p">)</span>

    <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdev_lower</span><span class="p">,</span> <span class="n">stdev_higher</span><span class="p">)</span>

    <span class="c1"># Plot 95% CI</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                      <span class="n">model</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="o">*</span><span class="n">params_optimised</span><span class="p">)</span> <span class="o">-</span> <span class="n">stdev</span> <span class="o">*</span> <span class="mf">1.96</span><span class="p">,</span>
                      <span class="n">model</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="o">*</span><span class="n">params_optimised</span><span class="p">)</span> <span class="o">+</span> <span class="n">stdev</span> <span class="o">*</span> <span class="mf">1.96</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span>
                      <span class="p">)</span>

    <span class="k">return</span> <span class="n">stdev</span></div>



<div class="viewcode-block" id="centriole_model_xy_distances_9fold_variable_vertices">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.centriole_model_xy_distances_9fold_variable_vertices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">centriole_model_xy_distances_9fold_variable_vertices</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span>
        <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for XY distances between localisations of a centriolar</span>
<span class="sd">    protein.</span>

<span class="sd">    Args:</span>
<span class="sd">        separation_values (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        diameter (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertssd (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">            distances between the vertices.</span>
<span class="sd">        vertamp1, vertamp2, vertamp3, vertamp4 (float):</span>
<span class="sd">            Amplitudes of the contributions of the different inter-vertex</span>
<span class="sd">            distances.</span>
<span class="sd">        replocssd (float):</span>
<span class="sd">            Spread representing localisation precision for repeated</span>
<span class="sd">            localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">            of the same fluorescent molecule.</span>
<span class="sd">        substructsd (float):</span>
<span class="sd">            Spread of a contribution resulting from unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructamp (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">           The relative position density given by the model</span>
<span class="sd">           at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set non-fittable symmetry order</span>
    <span class="n">sym_order</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="c1"># Prepare amplitudes of the different inter-vertex distances</span>
    <span class="c1"># for easy use.</span>
    <span class="n">vertices_contributions</span> <span class="o">=</span> <span class="p">[</span><span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">]</span>

    <span class="c1"># Calculate the inter-vertex distances</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">generate_polygon_points</span><span class="p">(</span><span class="n">sym_order</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>

    <span class="n">filter_distance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diameter</span><span class="p">)</span>
    <span class="c1"># Need to get unsorted relative positions, to find unique distances</span>
    <span class="c1"># at the start of the output list from getdistance(),</span>
    <span class="c1"># so use sort_and_halve=False.</span>
    <span class="n">relative_positions</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span>
                                      <span class="n">filter_distance</span><span class="p">,</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">sort_and_halve</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xy_separations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                             <span class="o">+</span> <span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">unique_xy_seps</span> <span class="o">=</span> <span class="n">xy_separations</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sym_order</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>

    <span class="c1"># Include the contributions from the inter-vertex distance in the RPD.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">separation_values</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_xy_seps</span><span class="p">):</span>
        <span class="n">rpd</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpd</span>
               <span class="o">+</span> <span class="n">vertices_contributions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
               <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                <span class="n">distance</span><span class="p">,</span>
                                                <span class="n">vertssd</span>
                                                <span class="p">)</span>
               <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">replocsamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="centriole_model_xy_distances_9fold_variable_vertices_vectorargs">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.centriole_model_xy_distances_9fold_variable_vertices_vectorargs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">centriole_model_xy_distances_9fold_variable_vertices_vectorargs</span><span class="p">(</span>
        <span class="n">input_vector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to calculate the values given by</span>
<span class="sd">    centriole_model_xy_distances_9fold_variable_vertices, but using a</span>
<span class="sd">    vector input for the parameters, so that the numdifftools package can be</span>
<span class="sd">    used to calculate partial derivatives for correct error propagation in the</span>
<span class="sd">    model.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_vector (list or numpy array):</span>
<span class="sd">            A concatenation of:</span>
<span class="sd">                1. A distance at which density values of the model will be</span>
<span class="sd">                obtained (numpy array)</span>

<span class="sd">                2. The parameters used by</span>
<span class="sd">                centriole_model_xy_distances_9fold_variable_vertices</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model at the input</span>
<span class="sd">            distances (called separation_values_1d).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
     <span class="n">diameter</span><span class="p">,</span>
     <span class="n">vertssd</span><span class="p">,</span>
     <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
     <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
     <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_vector</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">centriole_model_xy_distances_9fold_variable_vertices</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span>
        <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="centriole_model_xy_distances_9fold_variable_vertices_internal_bg">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.centriole_model_xy_distances_9fold_variable_vertices_internal_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">centriole_model_xy_distances_9fold_variable_vertices_internal_bg</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span>
        <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
        <span class="n">bg_dia</span><span class="p">,</span> <span class="n">bg_amp</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametric model for XY distances between localisations of a centriolar</span>
<span class="sd">    protein. Background is modelled as resulting from a disk with isotropic</span>
<span class="sd">    localisations (this provides a reasonable fit to the distance</span>
<span class="sd">    histograms for the less-ordered centriole images).</span>

<span class="sd">    Args:</span>
<span class="sd">        separation_values (numpy array):</span>
<span class="sd">            Distances at which density values of the model will be obtained.</span>
<span class="sd">        diameter (float):</span>
<span class="sd">            Diameter of the circle containing the vertices of the polygon.</span>
<span class="sd">        vertssd (float):</span>
<span class="sd">            Broadening of the peaks located at</span>
<span class="sd">            distances between the vertices.</span>
<span class="sd">        vertamp1, vertamp2, vertamp3, vertamp4 (float):</span>
<span class="sd">            Amplitudes of the contributions of the different inter-vertex</span>
<span class="sd">            distances.</span>
<span class="sd">        replocssd (float):</span>
<span class="sd">            Spread representing localisation precision for repeated</span>
<span class="sd">            localisations of the same fluorescent molecule.</span>
<span class="sd">        replocsamp (float):</span>
<span class="sd">            Amplitude of the contribution of repeated localisations</span>
<span class="sd">            of the same fluorescent molecule.</span>
<span class="sd">        substructsd (float):</span>
<span class="sd">            Spread of a contribution resulting from unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        substructamp (float):</span>
<span class="sd">            Amplitude of the contribution of unresolvable</span>
<span class="sd">            substructure, or mislocalisations resulting from</span>
<span class="sd">            a combination of simultaneous nearby emitters.</span>
<span class="sd">        bg_dia (float):</span>
<span class="sd">            Diameter of the disk containing the modelled background</span>
<span class="sd">            localisations.</span>
<span class="sd">        bg_amp (float):</span>
<span class="sd">            Amplitude of the background component.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">           The relative position density given by the model</span>
<span class="sd">           at distances r.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set non-fittable symmetry order</span>
    <span class="n">sym_order</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="c1"># Prepare amplitudes of the different inter-vertex distances</span>
    <span class="c1"># for easy use.</span>
    <span class="n">vertices_contributions</span> <span class="o">=</span> <span class="p">[</span><span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">]</span>

    <span class="c1"># Calculate the inter-vertex distances</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">generate_polygon_points</span><span class="p">(</span><span class="n">sym_order</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>

    <span class="n">filter_distance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diameter</span><span class="p">)</span>
    <span class="c1"># Need to get unsorted relative positions, to find unique distances</span>
    <span class="c1"># at the start of the output list from getdistance(),</span>
    <span class="c1"># so use sort_and_halve=False.</span>
    <span class="n">relative_positions</span> <span class="o">=</span> <span class="n">getdistances</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span>
                                      <span class="n">filter_distance</span><span class="p">,</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">sort_and_halve</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xy_separations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                             <span class="o">+</span> <span class="n">relative_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">unique_xy_seps</span> <span class="o">=</span> <span class="n">xy_separations</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sym_order</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>

    <span class="c1"># Include the contributions from the inter-vertex distance in the RPD.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">separation_values</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_xy_seps</span><span class="p">):</span>
        <span class="n">rpd</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpd</span>
               <span class="o">+</span> <span class="n">vertices_contributions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
               <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                <span class="n">distance</span><span class="p">,</span>
                                                <span class="n">vertssd</span>
                                                <span class="p">)</span>
               <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for repeated localisations.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">replocsamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">replocssd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add pair correlation distribution for unresolvable substructure/</span>
    <span class="c1"># mislocalisations of simultaneous nearby emitters.</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="p">(</span><span class="n">substructamp</span>
                 <span class="o">*</span> <span class="n">models</span><span class="o">.</span><span class="n">pairwise_correlation_2d</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                                  <span class="mf">0.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">substructsd</span>
                                                  <span class="p">)</span>
                 <span class="p">)</span>

    <span class="c1"># Add background within disk</span>
    <span class="n">separation_values_below_bg_dia</span> <span class="o">=</span> <span class="n">separation_values</span><span class="p">[</span><span class="n">separation_values</span>
                                                       <span class="o">&lt;</span> <span class="n">bg_dia</span><span class="p">]</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">bg_amp</span> <span class="o">*</span> <span class="n">pair_correlation_disk</span><span class="p">(</span><span class="n">separation_values_below_bg_dia</span><span class="p">,</span>
                                                <span class="n">radius</span><span class="o">=</span><span class="n">bg_dia</span><span class="o">/</span><span class="mf">2.</span>
                                                <span class="p">)</span>

    <span class="n">rpd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">background</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rpd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">background</span><span class="p">)]</span> <span class="o">+</span> <span class="n">background</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="centriole_model_xy_distances_9fold_variable_vertices_internal_bg_vectorargs">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.centriole_model_xy_distances_9fold_variable_vertices_internal_bg_vectorargs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">centriole_model_xy_distances_9fold_variable_vertices_internal_bg_vectorargs</span><span class="p">(</span>
        <span class="n">input_vector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to calculate the values given by</span>
<span class="sd">    centriole_model_xy_distances_9fold_variable_vertices, but using a</span>
<span class="sd">    vector input for the parameters, so that the numdifftools package can be</span>
<span class="sd">    used to calculate partial derivatives for correct error propagation in the</span>
<span class="sd">    model.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_vector (list or numpy array):</span>
<span class="sd">            A concatenation of:</span>
<span class="sd">                1. A distance at which density values of the model will be</span>
<span class="sd">                obtained (numpy array)</span>

<span class="sd">                2. The parameters used by</span>
<span class="sd">                centriole_model_xy_distances_9fold_variable_vertices</span>
<span class="sd">    Returns:</span>
<span class="sd">        rpd (numpy array):</span>
<span class="sd">            The relative position density given by the model at the input</span>
<span class="sd">            distances (called separation_values_1d).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
     <span class="n">diameter</span><span class="p">,</span>
     <span class="n">vertssd</span><span class="p">,</span>
     <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
     <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
     <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
     <span class="n">bg_dia</span><span class="p">,</span> <span class="n">bg_amp</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_vector</span>

    <span class="n">rpd</span> <span class="o">=</span> <span class="n">centriole_model_xy_distances_9fold_variable_vertices</span><span class="p">(</span>
        <span class="n">separation_values</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">vertssd</span><span class="p">,</span>
        <span class="n">vertamp1</span><span class="p">,</span> <span class="n">vertamp2</span><span class="p">,</span> <span class="n">vertamp3</span><span class="p">,</span> <span class="n">vertamp4</span><span class="p">,</span>
        <span class="n">replocssd</span><span class="p">,</span> <span class="n">replocsamp</span><span class="p">,</span>
        <span class="n">substructsd</span><span class="p">,</span> <span class="n">substructamp</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Need to add background below bg_diameter separately for differentiation</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">rpd</span> <span class="o">+</span> <span class="n">bg_amp</span> <span class="o">*</span> <span class="n">pair_correlation_disk</span><span class="p">(</span><span class="n">separation_values</span><span class="p">,</span>
                                               <span class="n">radius</span><span class="o">=</span><span class="n">bg_dia</span><span class="o">/</span><span class="mf">2.</span>
                                               <span class="p">)</span>

    <span class="k">return</span> <span class="n">rpd</span></div>



<div class="viewcode-block" id="create_default_fitting_params_dicts">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.create_default_fitting_params_dicts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_default_fitting_params_dicts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create lists for initial guesses and bounds for parameters during</span>
<span class="sd">    fitting. Sets the defaults for scipy.optimise.curve_fit</span>

<span class="sd">    Returns:</span>
<span class="sd">        lower_bound_dict (dict):</span>
<span class="sd">            Dictionary of default lower bound options for parameter values.</span>
<span class="sd">        upper_bound_dict (dict):</span>
<span class="sd">            Dictionary of default upper bound options for parameter values.</span>
<span class="sd">        initial_params_dict (dict):</span>
<span class="sd">            Dictionary of default initial parameter value options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Lower bounds (switched off)</span>
    <span class="n">lower_bound_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertssd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertsamp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp3&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp4&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;replocssd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;replocsamp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;substructsd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;substructamp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_dia&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;bg_amp&#39;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>

    <span class="c1"># Upper bounds (switched off)</span>
    <span class="n">upper_bound_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;vertssd&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;vertsamp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp3&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;vertamp4&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;replocssd&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;replocsamp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;substructsd&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;substructamp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;bg_dia&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s1">&#39;bg_amp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                        <span class="p">}</span>

    <span class="c1"># Initial guesses, set to default value of 1</span>
    <span class="n">initial_params_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;vertssd&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;vertsamp&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;vertamp1&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;vertamp2&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;vertamp3&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;vertamp4&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;replocssd&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;replocsamp&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;substructsd&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;substructamp&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;bg_dia&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
                           <span class="s1">&#39;bg_amp&#39;</span><span class="p">:</span> <span class="mf">1.</span>
                           <span class="p">}</span>

    <span class="k">return</span> <span class="n">lower_bound_dict</span><span class="p">,</span> <span class="n">upper_bound_dict</span><span class="p">,</span> <span class="n">initial_params_dict</span></div>



<div class="viewcode-block" id="set_up_variable_vertices_model_9fold_no_bg_with_fit_settings">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.set_up_variable_vertices_model_9fold_no_bg_with_fit_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_up_variable_vertices_model_9fold_no_bg_with_fit_settings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the RPD model with its fitting settings to pass to scipy&#39;s</span>
<span class="sd">    curve_fit, and the vector-input version of it for differentiation with</span>
<span class="sd">    numdifftools.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable_vertices_model_9fold_no_bg_with_fit_settings</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ModelWithFitSettings</span><span class="p">(</span>
            <span class="n">model_rpd</span><span class="o">=</span><span class="n">centriole_model_xy_distances_9fold_variable_vertices</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="p">(</span><span class="n">lower_bound_dict</span><span class="p">,</span>
     <span class="n">upper_bound_dict</span><span class="p">,</span>
     <span class="n">initial_params_dict</span><span class="p">)</span> <span class="o">=</span> <span class="n">create_default_fitting_params_dicts</span><span class="p">()</span>

    <span class="c1"># Can optionally modify these dictionaries here.</span>

    <span class="n">initial_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertssd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp1&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp2&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp3&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp4&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;replocssd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;replocsamp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;substructsd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;substructamp&#39;</span><span class="p">],</span>
                      <span class="p">]</span>

    <span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertssd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp1&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp2&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp3&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp4&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocssd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocsamp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructsd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructamp&#39;</span><span class="p">],</span>
                    <span class="p">]</span>

    <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertssd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp1&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp2&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp3&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp4&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocssd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocsamp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructsd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructamp&#39;</span><span class="p">],</span>
                    <span class="p">]</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bounds</span><span class="p">,</span> <span class="n">upper_bounds</span><span class="p">)</span>

    <span class="n">variable_vertices_model_9fold_no_bg_with_fit_settings</span><span class="o">.</span><span class="n">initial_params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">initial_params</span>
        <span class="p">)</span>
    <span class="n">variable_vertices_model_9fold_no_bg_with_fit_settings</span><span class="o">.</span><span class="n">param_bounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bounds</span>
        <span class="p">)</span>
    <span class="n">variable_vertices_model_9fold_no_bg_with_fit_settings</span><span class="o">.</span><span class="n">vector_input_model</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">centriole_model_xy_distances_9fold_variable_vertices_vectorargs</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">variable_vertices_model_9fold_no_bg_with_fit_settings</span></div>



<div class="viewcode-block" id="set_up_variable_vertices_model_9fold_internal_bg_with_fit_settings">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.set_up_variable_vertices_model_9fold_internal_bg_with_fit_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_up_variable_vertices_model_9fold_internal_bg_with_fit_settings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the RPD model with its fitting settings to pass to scipy&#39;s</span>
<span class="sd">    curve_fit, and the vector-input version of it for differentiation with</span>
<span class="sd">    numdifftools.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable_vertices_model_9fold_internal_bg_with_fit_settings</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ModelWithFitSettings</span><span class="p">(</span>
            <span class="n">model_rpd</span><span class="o">=</span><span class="n">centriole_model_xy_distances_9fold_variable_vertices_internal_bg</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="p">(</span><span class="n">lower_bound_dict</span><span class="p">,</span>
     <span class="n">upper_bound_dict</span><span class="p">,</span>
     <span class="n">initial_params_dict</span><span class="p">)</span> <span class="o">=</span> <span class="n">create_default_fitting_params_dicts</span><span class="p">()</span>

    <span class="c1"># Can optionally modify these dictionaries here:</span>

    <span class="n">initial_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertssd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp1&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp2&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertamp3&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;vertsamp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;replocssd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;replocsamp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;substructsd&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;substructamp&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;bg_dia&#39;</span><span class="p">],</span>
                      <span class="n">initial_params_dict</span><span class="p">[</span><span class="s1">&#39;bg_amp&#39;</span><span class="p">]</span>
                      <span class="p">]</span>

    <span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertssd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp1&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp2&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp3&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp4&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocssd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocsamp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructsd&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructamp&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_dia&#39;</span><span class="p">],</span>
                    <span class="n">lower_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_amp&#39;</span><span class="p">]</span>
                    <span class="p">]</span>

    <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertssd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp1&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp2&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp3&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;vertamp4&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocssd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;replocsamp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructsd&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;substructamp&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_dia&#39;</span><span class="p">],</span>
                    <span class="n">upper_bound_dict</span><span class="p">[</span><span class="s1">&#39;bg_amp&#39;</span><span class="p">]</span>
                    <span class="p">]</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bounds</span><span class="p">,</span> <span class="n">upper_bounds</span><span class="p">)</span>

    <span class="n">variable_vertices_model_9fold_internal_bg_with_fit_settings</span><span class="o">.</span><span class="n">initial_params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">initial_params</span>
        <span class="p">)</span>
    <span class="n">variable_vertices_model_9fold_internal_bg_with_fit_settings</span><span class="o">.</span><span class="n">param_bounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bounds</span>
        <span class="p">)</span>
    <span class="n">variable_vertices_model_9fold_internal_bg_with_fit_settings</span><span class="o">.</span><span class="n">vector_input_model</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">centriole_model_xy_distances_9fold_variable_vertices_internal_bg_vectorargs</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">variable_vertices_model_9fold_internal_bg_with_fit_settings</span></div>



<div class="viewcode-block" id="sum_distance_histograms">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.sum_distance_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sum_distance_histograms</span><span class="p">(</span><span class="n">distance_histogram_list</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add together distance histograms from a list, to aggregate results over</span>
<span class="sd">    multiple centrioles.</span>

<span class="sd">    Args:</span>
<span class="sd">        distance_histograms_list (2D numpy array):</span>
<span class="sd">            List of distance histogram bin values. One distance histogram</span>
<span class="sd">            per row.</span>
<span class="sd">        normalise (bool):</span>
<span class="sd">            Decide whether to normalise the histograms so that the mean</span>
<span class="sd">            bin value is 1 (good for scipy&#39;s curve_fit on individual</span>
<span class="sd">            centriole data).</span>

<span class="sd">    Returns:</span>
<span class="sd">        result (numpy array):</span>
<span class="sd">            Sum of the distance histograms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">one_histogram</span> <span class="ow">in</span> <span class="n">distance_histogram_list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">one_histogram</span>

    <span class="c1"># Normalise</span>
    <span class="k">if</span> <span class="n">normalise</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="make_fit_results_table_variable_vertices_model_9fold_no_bg">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.make_fit_results_table_variable_vertices_model_9fold_no_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_fit_results_table_variable_vertices_model_9fold_no_bg</span><span class="p">(</span>
        <span class="n">distance_histograms_list</span><span class="p">,</span>
        <span class="n">model_with_info</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make tables of fitted parameter estimates and uncertainties, and</span>
<span class="sd">    their ratios.</span>

<span class="sd">    Args:</span>
<span class="sd">        distance_histograms_list (list of numpy arrays (e.g. 2D numpy array)):</span>
<span class="sd">            List with each element being the distance histogram for one</span>
<span class="sd">            centriole image. We assume the distance histograms to have the</span>
<span class="sd">            same length, and the bin centres to be at distances of</span>
<span class="sd">            (integer + 0.5) nm</span>
<span class="sd">        model_with_info (ModelWithFitSettings object):</span>
<span class="sd">            The model to be fitted, with initial parameter guesses and</span>
<span class="sd">            bounds on allowable parameter values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        estimated_params_df (pandas dataframe):</span>
<span class="sd">            Dataframe containing the index and fitted parameter</span>
<span class="sd">            estimates for each distance histogram in distance_histograms_list.</span>
<span class="sd">        error_on_params_df (pandas dataframe):</span>
<span class="sd">            Dataframe containing the index and errors on the fitted</span>
<span class="sd">            parameters for each distance histogram in distance_histograms_list.</span>
<span class="sd">        ratios (pandas dataframe):</span>
<span class="sd">            Dataframe containing the index and error/estimate ratios for</span>
<span class="sd">            each parameter for each distance histogram in</span>
<span class="sd">            distance_histograms_list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up dataframes for fit results</span>
    <span class="n">estimated_params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;diameter&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;vertices_broadening&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;peak1_amp&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;peak2_amp&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;peak3_amp&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;peak4_amp&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;rept_locs_sd&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;rept_locs_amp&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;substruct_sd&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;substruct_amp&#39;</span>
                                                <span class="p">]</span>
                                       <span class="p">)</span>

    <span class="n">error_on_params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;diameter&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;vertices_broadening&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;peak1_amp&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;peak2_amp&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;peak3_amp&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;peak4_amp&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;rept_locs_sd&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;rept_locs_amp&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;substruct_sd&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;substruct_amp&#39;</span>
                                               <span class="p">]</span>
                                      <span class="p">)</span>

    <span class="c1"># Populate the tables</span>
    <span class="n">max_fit_distance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distance_histograms_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">distance_histograms_list</span><span class="p">):</span>
        <span class="c1"># Do the fit</span>
        <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
         <span class="n">params_covar</span><span class="p">,</span>
         <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span>
             <span class="n">distance_histograms_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
             <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
             <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
             <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
             <span class="n">fitlength</span><span class="o">=</span><span class="n">max_fit_distance</span>
             <span class="p">)</span>

        <span class="c1"># Add a row to the table, including centriole number</span>
        <span class="c1"># Make centriole numbers integers</span>
        <span class="n">table_row_estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">params_optimised</span><span class="p">)</span>
        <span class="n">table_row_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">params_1sd_error</span><span class="p">)</span>

        <span class="n">estimated_params_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_row_estimates</span>
        <span class="n">estimated_params_df</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">estimated_params_df</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">error_on_params_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_row_errors</span>
        <span class="n">error_on_params_df</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">error_on_params_df</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="c1"># Make table of ratios of error / estimate</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="n">error_on_params_df</span> <span class="o">/</span> <span class="n">estimated_params_df</span>
    <span class="n">ratios</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimated_params_df</span><span class="p">[</span><span class="s1">&#39;centriole_number&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">estimated_params_df</span><span class="p">,</span> <span class="n">error_on_params_df</span><span class="p">,</span> <span class="n">ratios</span></div>



<div class="viewcode-block" id="select_centrioles_by_error_ratio_threshold_on_peaks">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.select_centrioles_by_error_ratio_threshold_on_peaks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_centrioles_by_error_ratio_threshold_on_peaks</span><span class="p">(</span>
        <span class="n">ratios_df</span><span class="p">,</span> <span class="n">ratio_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_peaks_required_below_threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Choose centrioles based on the number of peaks corresponding to</span>
<span class="sd">    inter-vertex distances) in the fitted model that have error/estimate</span>
<span class="sd">    ratio below a threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        ratios_df (pandas dataframe):</span>
<span class="sd">            Dataframe containing the index and error/estimate ratios for</span>
<span class="sd">            each parameter for at least one distance histogram.</span>
<span class="sd">        ratio_threshold (float):</span>
<span class="sd">            Ratio of error/estimate for peak amplitudes, above which</span>
<span class="sd">            centrioles will be excluded from the selection.</span>
<span class="sd">        n_peaks_required_below_threshold (int):</span>
<span class="sd">            The number of peaks required to be below the error/estimate</span>
<span class="sd">            threshold, for the distance histogram to be selected.</span>

<span class="sd">    Returns:</span>
<span class="sd">        selected_centriole_numbers (list of integers):</span>
<span class="sd">            List of indices for centrioles with the required</span>
<span class="sd">            error/estimate ratios for the peak amplitudes corresponding</span>
<span class="sd">            to inter-vertex distances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set &lt; or &gt;= threshold to binary values</span>
    <span class="n">ratios_below_threshold_df</span> <span class="o">=</span> <span class="n">ratios_df</span> <span class="o">&lt;</span> <span class="n">ratio_threshold</span>
    <span class="n">ratios_below_threshold_df</span> <span class="o">=</span> <span class="n">ratios_below_threshold_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Calculate the number of peaks below the ratio threshold per row</span>
    <span class="n">n_peaks_below_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratios_below_threshold_df</span><span class="o">.</span><span class="n">peak1_amp</span> <span class="o">+</span>
                               <span class="n">ratios_below_threshold_df</span><span class="o">.</span><span class="n">peak2_amp</span> <span class="o">+</span>
                               <span class="n">ratios_below_threshold_df</span><span class="o">.</span><span class="n">peak3_amp</span> <span class="o">+</span>
                               <span class="n">ratios_below_threshold_df</span><span class="o">.</span><span class="n">peak4_amp</span>
                               <span class="p">)</span>

    <span class="c1"># Select the rows with &gt;= the required number of peaks below the</span>
    <span class="c1"># ratio threshold</span>
    <span class="n">selected_below_threshold</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ratios_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n_peaks_below_threshold</span>
                      <span class="o">&gt;=</span> <span class="n">n_peaks_required_below_threshold</span>
                      <span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Get the centriole numbers</span>
    <span class="n">selected_centriole_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selected_below_threshold</span><span class="o">.</span><span class="n">centriole_number</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">selected_centriole_numbers</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../perpl.modelling.html#perpl.modelling.centriole_analysis.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do stuff.&quot;&quot;&quot;</span>
    <span class="n">outfile_root</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Temp</span><span class="se">\\</span><span class="s1">Centriole</span><span class="se">\\</span><span class="s1">analysis_results&#39;</span>

    <span class="c1"># Get centriole localisations to analyse</span>
    <span class="n">locs_per_centriole</span> <span class="o">=</span> <span class="n">get_input_data</span><span class="p">()</span>

    <span class="c1"># Set filter to remove imprecise localisations</span>
    <span class="n">max_localisation_precision</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">outfile_root</span> <span class="o">=</span> <span class="p">(</span><span class="n">outfile_root</span>
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">max_localisation_precision</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;nm_precision&#39;</span>
                    <span class="p">)</span>

    <span class="c1"># Get a list of XY-distances between localisations within each centriole,</span>
    <span class="c1"># with one list item per centriole.</span>
    <span class="n">distances_xy_per_centriole</span> <span class="o">=</span> <span class="n">get_xy_distances</span><span class="p">(</span><span class="n">locs_per_centriole</span><span class="p">,</span>
                                                  <span class="n">max_localisation_precision</span>
                                                  <span class="p">)</span>

    <span class="n">outfile_relpos</span> <span class="o">=</span> <span class="n">outfile_root</span> <span class="o">+</span> <span class="s1">&#39;_distances_xy.npy&#39;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile_relpos</span><span class="p">,</span> <span class="n">distances_xy_per_centriole</span><span class="p">)</span>

    <span class="c1"># Set upper limit on distances in histograms and fits</span>
    <span class="n">max_fit_distance</span> <span class="o">=</span> <span class="mi">500</span>

    <span class="c1"># Make list of distance histograms, with each list item being the</span>
    <span class="c1"># distance histogram for one centriole.</span>
    <span class="c1"># Mean bin value is 1.</span>
    <span class="p">(</span><span class="n">distance_histograms_list</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">make_distance_histograms_per_centriole</span><span class="p">(</span><span class="n">distances_xy_per_centriole</span><span class="p">,</span>
                                                <span class="n">max_fit_distance</span>
                                                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">outfile_dist_hist_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">outfile_root</span>
                              <span class="o">+</span> <span class="s1">&#39;_distance_histograms_normalised.npy&#39;</span>
                              <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile_dist_hist_list</span><span class="p">,</span> <span class="n">distance_histograms_list</span><span class="p">)</span>

    <span class="c1"># Make list of distance histograms, with each list item being the</span>
    <span class="c1"># distance histogram for one centriole.</span>
    <span class="c1"># Bin values not normalised.</span>
    <span class="p">(</span><span class="n">distance_histograms_list</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">make_distance_histograms_per_centriole</span><span class="p">(</span><span class="n">distances_xy_per_centriole</span><span class="p">,</span>
                                                <span class="n">max_fit_distance</span><span class="p">,</span>
                                                <span class="n">normalise</span><span class="o">=</span><span class="kc">False</span>
                                                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">outfile_dist_hist_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">outfile_root</span>
                              <span class="o">+</span> <span class="s1">&#39;_distance_histograms_not_normalised.npy&#39;</span>
                              <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile_dist_hist_list</span><span class="p">,</span> <span class="n">distance_histograms_list</span><span class="p">)</span>

    <span class="c1"># Choose model</span>
    <span class="c1"># model_with_info = set_up_variable_vertices_model_9fold_internal_bg_with_fit_settings()</span>
    <span class="n">model_with_info</span> <span class="o">=</span> <span class="n">set_up_variable_vertices_model_9fold_no_bg_with_fit_settings</span><span class="p">()</span>

    <span class="c1"># Could modify the fit parameter settings here</span>

    <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span> <span class="o">=</span> <span class="p">[</span><span class="c1"># diameter,</span>
                                      <span class="c1"># vertssd,</span>
                                      <span class="c1"># vertsamp</span>
                                      <span class="c1"># vertamp1, vertamp2, vertamp3, vertamp4,</span>
                                      <span class="c1"># replocssd, replocsamp,</span>
                                      <span class="c1"># substructsd, substructamp,</span>
                                      <span class="c1"># bg_dia, bg_amp</span>
                                      <span class="mf">300.0</span><span class="p">,</span>
                                      <span class="mf">35.0</span><span class="p">,</span>
                                      <span class="c1">#100.,</span>
                                      <span class="mf">100.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
                                      <span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span>
                                      <span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]</span>
                                      <span class="c1"># 300., 10.]</span>

    <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="c1"># diameter,</span>
                                        <span class="c1"># vertssd,</span>
                                        <span class="c1"># vertsamp</span>
                                        <span class="c1"># vertamp1, vertamp2, vertamp3, vertamp4,</span>
                                        <span class="c1"># replocssd, replocsamp,</span>
                                        <span class="c1"># substructsd, substructamp,</span>
                                        <span class="c1"># bg_dia, bg_amp</span>
                                        <span class="mf">400.0</span><span class="p">,</span>
                                        <span class="mf">1000.0</span><span class="p">,</span>
                                        <span class="c1">#500.,</span>
                                        <span class="mf">500.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">,</span>
                                        <span class="mf">50.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">,</span>
                                        <span class="mf">50.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">]</span>
                                        <span class="c1"># 1000., 100.]</span>
                                    <span class="p">)</span>

    <span class="c1"># Make dataframes containing fitted parameters, their 1 SD uncertainties,</span>
    <span class="c1"># and the ratios between them.</span>
    <span class="c1"># Use the normalised histograms.</span>
    <span class="p">(</span><span class="n">estimated_params_df</span><span class="p">,</span>
     <span class="n">error_on_params_df</span><span class="p">,</span>
     <span class="n">error_to_estimate_ratios_df</span>
     <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">make_fit_results_table_variable_vertices_model_9fold_no_bg</span><span class="p">(</span>
          <span class="n">distance_histograms_list</span><span class="p">,</span> <span class="n">model_with_info</span><span class="p">)</span>
          <span class="p">)</span>
<span class="c1">#     estimated_params_df.to_csv(</span>
<span class="c1">#         &#39;C:/Temp/Centriole/5nm_precision_distance_histograms_normalised_parameter_estimates.csv&#39;,</span>
<span class="c1">#         index=False</span>
<span class="c1">#         )</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">]:</span>
        <span class="c1"># Fit model to data</span>
        <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
         <span class="n">params_covar</span><span class="p">,</span>
         <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span>
             <span class="n">distance_histograms_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
             <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
             <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
             <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
             <span class="n">fitlength</span><span class="o">=</span><span class="n">max_fit_distance</span>
             <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimised, SD error&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;___________________&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">params_optimised</span><span class="p">,</span> <span class="n">params_1sd_error</span><span class="p">)))</span>

        <span class="c1"># Plot distance histogram</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot_distance_histogram</span><span class="p">(</span>
            <span class="n">distance_histograms_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">bin_edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_fit_distance</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Plot curve</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_fit_distance</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">fitted_curve_values</span> <span class="o">=</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                                        <span class="o">*</span><span class="n">params_optimised</span>
                                                        <span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">fitted_curve_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Plot 95% CI</span>
        <span class="c1"># For model with internal background</span>
        <span class="c1"># plot_95_ci_internal_bg(axes,</span>
        <span class="c1">#                       x_values,</span>
        <span class="c1">#                       model_with_info.model_rpd,</span>
        <span class="c1">#                       params_optimised,</span>
        <span class="c1">#                       params_covar,</span>
        <span class="c1">#                       params_optimised[-2],</span>
        <span class="c1">#                       model_with_info.vector_input_model)</span>

        <span class="c1"># For model without internal background</span>
        <span class="n">stdev</span> <span class="o">=</span> <span class="n">plot_95_ci</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span>
                           <span class="n">x_values</span><span class="p">,</span>
                           <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                           <span class="n">params_optimised</span><span class="p">,</span>
                           <span class="n">params_covar</span><span class="p">,</span>
                           <span class="n">model_with_info</span><span class="o">.</span><span class="n">vector_input_model</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Centriole &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39; (0 to&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">distance_histograms_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">&#39;)&#39;</span>
                       <span class="p">)</span>

    <span class="c1"># Sum the distance histograms</span>
    <span class="c1"># Use not normalised ones</span>
    <span class="c1"># Optionally select centrioles according to error to estimate ratios</span>
    <span class="c1"># of peak amplitudes</span>
    <span class="n">chosen_centrioles</span> <span class="o">=</span> <span class="n">select_centrioles_by_error_ratio_threshold_on_peaks</span><span class="p">(</span>
        <span class="n">error_to_estimate_ratios_df</span><span class="p">)</span>
    <span class="n">distance_histograms_list</span> <span class="o">=</span> <span class="n">distance_histograms_list</span><span class="p">[</span><span class="n">chosen_centrioles</span><span class="p">]</span>

    <span class="n">summed_histograms</span> <span class="o">=</span> <span class="n">sum_distance_histograms</span><span class="p">(</span><span class="n">distance_histograms_list</span><span class="p">,</span>
                                                <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="p">(</span><span class="n">params_optimised</span><span class="p">,</span>
     <span class="n">params_covar</span><span class="p">,</span>
     <span class="n">params_1sd_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">fit_model_to_experiment</span><span class="p">(</span>
         <span class="n">summed_histograms</span><span class="p">,</span>
         <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
         <span class="n">model_with_info</span><span class="o">.</span><span class="n">initial_params</span><span class="p">,</span>
         <span class="n">model_with_info</span><span class="o">.</span><span class="n">param_bounds</span><span class="p">,</span>
         <span class="n">fitlength</span><span class="o">=</span><span class="n">max_fit_distance</span>
         <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimised, SD error&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;___________________&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">params_optimised</span><span class="p">,</span> <span class="n">params_1sd_error</span><span class="p">)))</span>

    <span class="c1"># Plot distance histogram</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot_distance_histogram</span><span class="p">(</span>
        <span class="n">summed_histograms</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_fit_distance</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Plot curve</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_fit_distance</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">fitted_curve_values</span> <span class="o">=</span> <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span>
                                                    <span class="o">*</span><span class="n">params_optimised</span>
                                                    <span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">fitted_curve_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">stdev</span> <span class="o">=</span> <span class="n">plot_95_ci</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span>
                       <span class="n">x_values</span><span class="p">,</span>
                       <span class="n">model_with_info</span><span class="o">.</span><span class="n">model_rpd</span><span class="p">,</span>
                       <span class="n">params_optimised</span><span class="p">,</span>
                       <span class="n">params_covar</span><span class="p">,</span>
                       <span class="n">model_with_info</span><span class="o">.</span><span class="n">vector_input_model</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All centrioles&#39;</span><span class="p">)</span></div>



<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     main()</span>
<span class="c1"># start_time = time.time()  # Start timing it.</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">PERPL</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">perpl</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Alistair Curd.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>